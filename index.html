<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BAPEN Auto-I'lan</title>
  <link rel="icon" type="image/svg+xml" href="logo_bapen.svg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #d0b3ff;
      --secondary-color: #4CAF50;
      --background-color: #f5f3e3;
      --text-color: #2d2d2d;
      --border-radius: 12px;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 15px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 30px rgba(0,0,0,0.15);
      --container-padding: 30px;
      --grid-gap: 20px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Poppins', sans-serif;
      background: #f0f0f0; /* Changed from var(--background-color) to solid grey */
      color: var(--text-color);
      line-height: 1.6;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0;
      width: 100%;
      flex: 1;
    }

    .grid-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: var(--grid-gap);
      margin-bottom: var(--grid-gap);
    }

    .card {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 15px 20px;
      box-shadow: var(--shadow-md);
      animation: scaleIn 0.3s ease-out;
    }

    /* Header & Navigation */
    .top-bar {
      background: var(--text-color);
      color: #fff;
      padding: 15px var(--container-padding);
      margin: 0 0 var(--grid-gap);
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow-md);
    }

    .clock-container {
      display: flex;
      align-items: center;
      gap: 15px;
      background: rgba(255,255,255,0.1);
      padding: 12px 20px;
      border-radius: var(--border-radius);
      border: 1px solid rgba(255,255,255,0.2);
    }

    /* Prayer Times Table */
    .prayer-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      margin: var(--grid-gap) 0;
      overflow: hidden;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-md);
    }

    .prayer-table th {
      background: var(--primary-color);
      color: var(--text-color);
      padding: 15px;
      font-size: 1.1em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }

    .prayer-table td {
      background: #fff;
      padding: 20px 15px;
      text-align: center;
      font-size: 1.2em;
      font-weight: 500;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .prayer-table tr:last-child td {
      border-bottom: none;
    }

    /* Penanda waktu sholat aktif */
    .prayer-table th.active {
      background: #4CAF50;
      color: white;
    }

    .prayer-table td.active {
      background: #E8F5E9;
      font-weight: 700;
      color: #2E7D32;
    }

    /* Activities Section */
    .activities-section {
      background: #fff;
      border-radius: var(--border-radius);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      margin: var(--grid-gap) 0;
    }

    .activities-header {
      background: var(--primary-color);
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .activities-header h2 {
      color: var(--text-color);
      font-size: 1.1em;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
      margin: 0;
    }

    .activities-list {
      padding: 0;
    }

    .activity-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      animation: slideIn 0.3s ease-out;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    /* Modal Styling */
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      opacity: 0;
      visibility: hidden;
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      backdrop-filter: blur(5px);
      transition: all 0.3s ease;
    }

    .modal.show {
      opacity: 1;
      visibility: visible;
    }

    .modal-content {
      background: #fff;
      padding: 30px 40px;
      border-radius: var(--border-radius);
      width: 90%;
      max-width: 450px;
      box-shadow: var(--shadow-lg);
      transform: scale(0.8);
      opacity: 0;
      transition: all 0.3s ease;
    }

    .modal.show .modal-content {
      transform: scale(1);
      opacity: 1;
    }

    .modal-content h2 {
      margin: 0 0 25px;
      color: var(--text-color);
      font-size: 1.5em;
      text-align: center;
      font-weight: 600;
    }

    .form-group {
      margin-bottom: 12px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      color: var(--text-color);
      font-weight: 500;
      font-size: 0.95em;
    }

    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      font-size: 1em;
      transition: all 0.3s ease;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 3px rgba(208,179,255,0.2);
      transform: translateY(-1px);
    }

    .modal-buttons {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 30px;
    }

    .modal-buttons button {
      min-width: 120px;
      padding: 12px 25px;
      border: none;
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      font-size: 0.95em;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-buttons .btn-primary {
      background: var(--primary-color);
      color: var(--text-color);
    }

    .modal-buttons .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .modal-buttons button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .modal-buttons button:active {
      transform: translateY(0);
    }

    /* Animasi Modal */
    @keyframes slideIn {
      from {
        transform: translate(-50%, -60%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, -50%);
        opacity: 1;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    /* Dark mode support untuk modal */
    .dark-mode .modal-content {
      background: #2d2d2d;
      color: #fff;
    }

    .dark-mode .form-group label {
      color: #fff;
    }

    .dark-mode .form-group input {
      background: #3d3d3d;
      border-color: rgba(255,255,255,0.1);
      color: #fff;
    }

    .dark-mode .modal-buttons .btn-secondary {
      background: #3d3d3d;
      color: #fff;
    }

    @keyframes slideOut {
      from {
        transform: translateY(0);
        opacity: 1;
      }
      to {
        transform: translateY(20px);
        opacity: 0;
      }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.95);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-family: 'Poppins', sans-serif;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.2);
      transform: translate(-50%, -50%) scale(0);
      border-radius: 50%;
      transition: transform 0.5s ease-out;
    }

    .btn:active::after {
      transform: translate(-50%, -50%) scale(2);
    }

    .btn-primary {
      background: var(--primary-color);
      color: var(--text-color);
      font-weight: 600;
    }

    .btn-secondary {
      background: #f5f5f5;
      color: #666;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 6px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    /* Responsive Design */
    @media screen and (max-width: 768px) {
      :root {
        --container-padding: 15px;
        --grid-gap: 15px;
      }

      .main-container {
        padding: var(--container-padding);
      }

      .grid-container {
        grid-template-columns: 1fr;
      }

      /* Top Bar Mobile */
      .top-bar {
        flex-direction: column;
        gap: 10px;
        padding: 12px var(--container-padding);
      }

      .clock-container {
        width: 100%;
        justify-content: center;
      }

      /* Prayer Table Mobile */
      .prayer-table {
        font-size: 0.9em;
        margin: 10px 0;
      }

      .prayer-table th,
      .prayer-table td {
        padding: 10px 5px;
        font-size: 0.85em;
      }

      /* Controls Mobile */
      .controls {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .controls select,
      .controls button {
        width: 100%;
        padding: 12px;
        font-size: 0.9em;
      }

      /* Player Status Mobile */
      .player-status {
        flex-direction: column;
        padding: 12px;
        gap: 10px;
      }

      .status-left {
        width: 100%;
        justify-content: flex-start;
      }

      .auto-mode-toggle {
        width: 100%;
        justify-content: space-between;
        padding: 10px 0;
        border-left: none;
        border-right: none;
        border-top: 1px solid rgba(0,0,0,0.1);
        border-bottom: 1px solid rgba(0,0,0,0.1);
      }

      .status-right {
        width: 100%;
        text-align: center;
      }

      /* Modal Mobile */
      .modal-content {
        width: 95%;
        padding: 20px;
        margin: 10px;
      }

      .modal-content h2 {
        font-size: 1.2em;
      }

      .form-group input {
        font-size: 0.9em;
      }

      /* Activities Table Mobile */
      .activity-item td {
        padding: 10px 8px;
        font-size: 0.9em;
      }

      .activity-item td:last-child {
        padding-right: 8px !important;
      }

      .btn-icon {
        width: 28px;
        height: 28px;
        padding: 4px;
      }

      .btn-icon img {
        width: 18px;
        height: 18px;
      }

      /* Log Container Mobile */
      .log-container {
        padding: 12px;
        margin: 10px 0;
      }

      #audio-log {
        max-height: 200px;
        font-size: 0.85em;
      }

      .log-message {
        padding: 8px 12px;
        margin-bottom: 6px;
      }
    }

    /* Tambahan untuk device sangat kecil */
    @media screen and (max-width: 380px) {
      .prayer-table th,
      .prayer-table td {
        padding: 8px 4px;
        font-size: 0.8em;
      }

      .clock-container {
        font-size: 0.9em;
      }

      #date-hijri {
        font-size: 0.85em;
      }

      .status-text {
        font-size: 0.9em;
      }

      .countdown-title {
        font-size: 1.2em;
      }
    }

    /* Landscape Mode */
    @media screen and (max-height: 500px) and (orientation: landscape) {
      .top-bar {
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .main-container {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--grid-gap);
        align-items: start;
      }

      .prayer-table,
      .controls,
      .player-container {
        grid-column: span 2;
      }
    }

    /* Player & Status Styling */
    .player-container {
      margin: var(--grid-gap) 0;
    }

    .player-status {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 20px;
      padding: 15px 20px;
      background: #fff;
      border-radius: var(--border-radius);
      box-shadow: var(--shadow-sm);
      margin-bottom: 15px;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .status-left {
      display: flex;
      align-items: center;
      gap: 12px;
      min-width: 250px;
    }

    .status-icon-wrapper {
      flex: 0 0 auto;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      border-radius: 50%;
      padding: 8px;
      transition: all 0.3s ease;
      border: 1px solid rgba(0,0,0,0.1);
    }

    .status-text {
      font-family: 'Poppins', sans-serif;
      font-size: 0.95em;
      color: #ff3333;
      font-weight: 600;
      text-shadow: 0 0 1px rgba(0,0,0,0.1);
    }

    .player-status.playing .status-text {
      color: #00b300;
    }

    .player-status.bell .status-text {
      color: #ffb700;
    }

    .player-status:not(.playing):not(.bell) .status-text {
      color: #ff3333;
    }

    .auto-mode-toggle {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 20px;
      border-left: 1px solid rgba(0,0,0,0.1);
      border-right: 1px solid rgba(0,0,0,0.1);
    }

    .switch {
      position: relative;
      display: inline-block;
      width: 46px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 24px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    input:checked + .slider {
      background-color: var(--secondary-color);
    }

    input:checked + .slider:before {
      transform: translateX(22px);
    }

    .auto-mode-label {
      font-family: 'Poppins', sans-serif;
      font-size: 0.9em;
      color: #666;
      font-weight: 500;
    }

    #player {
      width: 100%;
      height: 48px;
      border-radius: var(--border-radius);
      background: #fff;
      border: 1px solid rgba(0,0,0,0.1);
    }

    /* Controls Styling */
    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: var(--grid-gap) 0;
    }

    .controls select,
    .controls button {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: var(--border-radius);
      font-family: 'Poppins', sans-serif;
      font-size: 0.95em;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .controls select {
      appearance: none;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNyAxMGw1IDUgNS01eiIgZmlsbD0iIzY2NiIvPjwvc3ZnPg==');
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 40px;
    }

    .controls select:hover,
    .controls button:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }

    .controls .btn-primary {
      background: var(--primary-color);
      color: var(--text-color);
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .controls .btn-secondary {
      background: #f5f5f5;
      color: #666;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    /* Countdown Styling */
    .countdown-title {
      font-size: 1.6em;
      color: var(--text-color);
      margin: 0 0 12px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .countdown-inline {
      font-size: 0.95em;
      color: #666;
      font-weight: 500;
    }

    #ilan-countdown {
      min-height: 24px;
      opacity: 1;
      transition: opacity 0.3s ease;
    }

    #ilan-countdown.hidden {
      opacity: 0;
    }

    /* Log Container Styling */
    .log-container {
      background: #fff;
      border-radius: var(--border-radius);
      padding: 20px;
      margin: var(--grid-gap) 0;
      box-shadow: var(--shadow-md);
    }

    #audio-log {
      max-height: 300px;
      overflow-y: auto;
      padding-right: 10px;
    }

    .log-message {
      padding: 10px 15px;
      margin-bottom: 8px;
      border-radius: 6px;
      background: rgba(0,0,0,0.02);
      border-left: 3px solid var(--primary-color);
      font-size: 0.9em;
      line-height: 1.5;
    }

    .log-message.success {
      border-left-color: var(--secondary-color);
      background: rgba(76,175,80,0.05);
    }

    .log-message.error {
      border-left-color: #f44336;
      background: rgba(244,67,54,0.05);
    }

    .log-message.warning {
      border-left-color: #ff9800;
      background: rgba(255,152,0,0.05);
    }

    /* Footer Styling */
    .footer {
      background: linear-gradient(135deg, #1a237e 0%, #0d1b3f 100%);
      color: rgba(255,255,255,0.9);
      padding: 30px var(--container-padding);
      margin-top: auto;
      text-align: center;
      position: relative;
      overflow: hidden;
    }

    .footer::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, 
        rgba(255,255,255,0) 0%,
        rgba(255,255,255,0.2) 50%,
        rgba(255,255,255,0) 100%);
    }

    .footer-content {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
    }

    .footer-logo {
      height: 40px;
      width: auto;
      transition: transform 0.3s ease;
    }

    .footer-logo:hover {
      transform: scale(1.05);
    }

    .footer-text {
      font-size: 0.95em;
      opacity: 0.9;
    }

    /* Responsive Footer */
    @media screen and (max-width: 768px) {
      .footer {
        padding: 20px var(--container-padding);
      }

      .footer-content {
        flex-direction: column;
        gap: 15px;
      }

      .footer-logo {
        height: 35px;
      }

      .footer-text {
        font-size: 0.9em;
      }
    }

    /* Animations & Transitions */
    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateY(0);
        opacity: 1;
      }
      to {
        transform: translateY(20px);
        opacity: 0;
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.95);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    .card {
      animation: scaleIn 0.3s ease-out;
    }

    .activity-item {
      animation: slideIn 0.3s ease-out;
    }

    .modal-content {
      animation: slideIn 0.3s ease-out;
    }

    .beta-banner {
      animation: slideIn 0.5s ease-out;
    }

    /* Dark Mode Toggle */
    .dark-mode-toggle {
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 48px;
      height: 48px;
      border-radius: 50%;
      background: #fff;
      border: none;
      box-shadow: var(--shadow-md);
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .dark-mode-toggle:hover {
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    .dark-mode-toggle:active {
      transform: scale(0.95);
    }

    /* Loading States */
    .loading {
      position: relative;
      pointer-events: none;
    }

    .loading::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.8);
      backdrop-filter: blur(2px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2em;
      color: var(--text-color);
    }

    .loading::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 30px;
      height: 30px;
      border: 3px solid var(--primary-color);
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      z-index: 1;
    }

    @keyframes spin {
      to { transform: translate(-50%, -50%) rotate(360deg); }
    }

    /* Interactive States */
    .btn {
      position: relative;
      overflow: hidden;
    }

    .btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 100%;
      height: 100%;
      background: rgba(255,255,255,0.2);
      transform: translate(-50%, -50%) scale(0);
      border-radius: 50%;
      transition: transform 0.5s ease-out;
    }

    .btn:active::after {
      transform: translate(-50%, -50%) scale(2);
    }

    /* Toast Notifications */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #333;
      color: #fff;
      padding: 12px 24px;
      border-radius: 30px;
      box-shadow: var(--shadow-md);
      font-size: 0.9em;
      z-index: 1000;
      animation: slideUp 0.3s ease-out;
    }

    @keyframes slideUp {
      from {
        transform: translate(-50%, 100%);
        opacity: 0;
      }
      to {
        transform: translate(-50%, 0);
        opacity: 1;
      }
    }

    .toast.success {
      background: var(--secondary-color);
    }

    .toast.error {
      background: #ff4444;
    }

    /* Hover Effects */
    .activity-item {
      position: relative;
      overflow: hidden;
    }

    .activity-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
      transform: translateX(-100%);
      transition: transform 0.6s ease;
    }

    .activity-item:hover::before {
      transform: translateX(100%);
    }

    /* Focus States */
    .form-group input:focus {
      transform: translateY(-1px);
    }

    .btn:focus,
    select:focus {
      outline: none;
      box-shadow: 0 0 0 3px rgba(208,179,255,0.3);
    }

    /* Dark Mode Transitions */
    body,
    .card,
    .activity-item,
    .form-group input,
    .btn-secondary {
      transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
    }

    /* Tambahkan CSS untuk input time */
    input[type="time"]::-webkit-datetime-edit-ampm-field {
      display: none;
    }

    input[type="time"] {
      font-family: 'Poppins', sans-serif;
      font-size: 1em;
      width: 100%;
      padding: 12px 15px;
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: var(--border-radius);
      transition: all 0.3s ease;
    }

    /* Sembunyikan tombol spinner */
    input[type="time"]::-webkit-inner-spin-button,
    input[type="time"]::-webkit-calendar-picker-indicator {
      display: none;
    }

    /* Tambahkan CSS untuk mengatur layout tombol */
    .activity-item td:last-child {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      padding-right: 15px !important;
    }

    .btn-icon {
      width: 32px;
      height: 32px;
      padding: 6px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: transparent;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-icon:hover {
      background: rgba(0,0,0,0.05);
      transform: translateY(-2px);
    }

    .btn-icon img {
      width: 20px;
      height: 20px;
    }

    /* Status Icons Styling */
    .status-icon {
      width: 24px;
      height: 24px;
      display: none;
    }

    .player-status .status-icon-wrapper {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #f5f5f5;
      border-radius: 50%;
      padding: 8px;
      transition: all 0.3s ease;
    }

    /* Tampilkan icon sesuai status */
    .player-status.playing .icon-speaker {
      display: block;
    }

    .player-status.bell .icon-bell {
      display: block;
    }

    .player-status:not(.playing):not(.bell) .icon-speaker {
      display: block;
      opacity: 0.5;
    }

    /* Warna status text */
    .player-status.playing .status-text {
      color: #00b300;
    }

    .player-status.bell .status-text {
      color: #ffb700;
    }

    .player-status:not(.playing):not(.bell) .status-text {
      color: #ff3333;
    }

    /* Form Controls Layout */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-bottom: 24px;
    }

    .content-grid {
      background: #f8f9fa;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin: 12px 0;
    }

    .content-fields {
      display: none;
      margin-top: 12px;
    }

    .content-section-title {
      font-size: 1.1em;
      margin: 10px 0 8px;
      color: #333;
      font-weight: 600;
      padding-bottom: 8px;
      border-bottom: 1px solid #e0e0e0;
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .form-group {
      margin-bottom: 0;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    .form-label {
      display: block;
      margin-bottom: 6px;
      font-size: 0.9em;
      color: #555;
      font-weight: 500;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.95em;
      transition: border-color 0.2s, box-shadow 0.2s;
      background-color: #fff;
      font-family: 'Poppins', sans-serif;
    }

    .form-control:focus {
      border-color: #8a63d2;
      box-shadow: 0 0 0 2px rgba(138, 99, 210, 0.2);
      outline: none;
    }

    .action-buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      border-radius: 6px;
      font-weight: 500;
      font-size: 0.95em;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      gap: 8px;
      font-family: 'Poppins', sans-serif;
    }

    .btn-primary {
      background-color: #8a63d2;
      color: white;
    }

    .btn-primary:hover {
      background-color: #7a53c2;
      transform: translateY(-1px);
    }

    .btn-secondary {
      background-color: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background-color: #e0e0e0;
      transform: translateY(-1px);
    }

    .icon {
      width: 16px;
      height: 16px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>

  <style>
    .announcement-bar {
      position: sticky;
      top: 0;
      z-index: 1000;
      background-color: #ffcc00;
      padding: 10px 0;
      margin: 0;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .announcement-text {
      font-size: 1.5em;
      font-weight: bold;
      color: #000;
      white-space: nowrap;
    }
    
    .announcement-bar marquee {
      line-height: 1.5;
    }
  </style>
  
  <div class="announcement-bar">
    <marquee scrollamount="8" behavior="scroll">
      <span class="announcement-text">
        ‚ö†Ô∏è MOHON UNTUK TIDAK MENG-CLOSE HALAMAN CHROME INI ‚ö†Ô∏è
      </span>
    </marquee>
  </div>

  <div class="top-bar">
    <div class="clock-container">
      <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTEuOTkgMkM2LjQ3IDIgMiA2LjQ4IDIgMTJzNC40NyAxMCA5Ljk5IDEwQzE3LjUyIDIyIDIyIDE3LjUyIDIyIDEyUzE3LjUyIDIgMTEuOTkgMnpNMTIgMjBjLTQuNDIgMC04LTMuNTgtOC04czMuNTgtOCA4LTggOCAzLjU4IDggOC0zLjU4IDgtOCA4eiIgZmlsbD0iI0ZGRiIvPjxwYXRoIGQ9Ik0xMi41IDdIMTF2NmwzLjI1IDMuMjUuNzUtLjc1TDEyLjUgMTZWN3oiIGZpbGw9IiNGRkYiLz48L3N2Zz4=" class="clock-icon" alt="clock">
      <div id="clock">--:--:--</div>
      <div class="location">Depok, Jawa Barat, Indonesia</div>
    </div>
    <div id="date-hijri">Loading...</div>
  </div>

  <div class="main-container">
    <div class="grid-container">
      <div class="card">
        <h1 class="countdown-title">
          <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTEuOTkgMkM2LjQ3IDIgMiA2LjQ4IDIgMTJzNC40NyAxMCA5Ljk5IDEwQzE3LjUyIDIyIDIyIDE3LjUyIDIyIDEyUzE3LjUyIDIgMTEuOTkgMnpNMTIgMjBjLTQuNDIgMC04LTMuNTgtOC04czMuNTgtOCA4LTggOCAzLjU4IDggOC0zLjU4IDgtOCA4eiIgZmlsbD0iIzJkMmQyZCIvPjxwYXRoIGQ9Ik0xMi41IDdIMTF2NmwzLjI1IDMuMjUuNzUtLjc1TDEyLjUgMTZWN3oiIGZpbGw9IiMyZDJkMmQiLz48L3N2Zz4=" class="icon icon-lg" alt="timer">
          <span id="countdown"></span>
        </h1>

        <div class="controls">
          <!-- Content Type Selection -->
          <div class="form-group full-width">
            <label for="contentType" class="form-label">Jenis Konten</label>
            <select id="contentType" class="form-control">
              <option value="">Pilih Jenis Konten</option>
              <option value="ilan">I'lan</option>
              <option value="siaran">Siaran Bahasa</option>
              <option value="murottal">Murottal</option>
            </select>
          </div>

          <div class="content-grid">
            <!-- I'lan Specific Fields -->
            <div id="ilan-fields" class="content-fields" style="display: none;">
              <h3 class="content-section-title">Pengaturan I'lan</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="member" class="form-label">Anggota</label>
                  <select id="member" class="form-control">
                    <option value="">Pilih Anggota</option>
                    <option value="alfatih">Al-Fatih</option>
                    <option value="imam" class="unavailable-option" disabled>Imam</option>
                    <option value="udin" class="unavailable-option" disabled>Udin</option>
                    <option value="gusti" class="unavailable-option" disabled>Gusti</option>
                    <option value="danish" class="unavailable-option" disabled>Danish</option>
                    <option value="feyrzan" class="unavailable-option" disabled>Feyrzan</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="prayer" class="form-label">Waktu Sholat</label>
                  <select id="prayer" class="form-control">
                    <option value="">Pilih Waktu Sholat</option>
                    <option value="subuh">Subuh</option>
                    <option value="dzuhur">Dzuhur</option>
                    <option value="ashar">Ashar</option>
                    <option value="maghrib">Maghrib</option>
                    <option value="isya">Isya</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="type" class="form-label">Jenis I'lan</label>
                  <select id="type" class="form-control">
                    <option value="">Pilih Jenis I'lan</option>
                    <option value="awal">Awal</option>
                    <option value="tsani">Tsani</option>
                    <option value="akhir">Akhir</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Siaran Bahasa Specific Fields -->
            <div id="siaran-fields" class="content-fields" style="display: none;">
              <h3 class="content-section-title">Siaran Bahasa</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="bahasa" class="form-label">Bahasa</label>
                  <select id="bahasa" class="form-control">
                    <option value="">Pilih Bahasa</option>
                    <option value="arab">Arab</option>
                    <option value="inggris">Inggris</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="siaran-file" class="form-label">File Siaran</label>
                  <select id="siaran-file" class="form-control" disabled>
                    <option value="">Pilih File Siaran</option>
                    <!-- Will be populated by JavaScript -->
                  </select>
                </div>
              </div>
            </div>

            <!-- Murottal Specific Fields -->
            <div id="murottal-fields" class="content-fields" style="display: none;">
              <h3 class="content-section-title">Murottal</h3>
              <div class="form-grid">
                <div class="form-group">
                  <label for="waktu-murottal" class="form-label">Waktu Murottal</label>
                  <select id="waktu-murottal" class="form-control">
                    <option value="">Pilih Waktu Murottal</option>
                    <option value="subuh">Pra-Subuh</option>
                    <option value="ashar">Pra-Ashar</option>
                  </select>
                </div>
                <div class="form-group">
                  <label for="surah" class="form-label">Surah</label>
                  <select id="surah" class="form-control" disabled>
                    <option value="">Pilih Surah</option>
                    <!-- Will be populated by JavaScript -->
                  </select>
                </div>
              </div>
            </div>
          </div>

          <div class="action-buttons">
            <button id="btnPlay" class="btn btn-primary">
              <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNOCA2djEybDEwLTZ6IiBmaWxsPSJ3aGl0ZSIvPjwvc3ZnPg==" class="icon" alt="play"> Putar
            </button>
            <button id="btnPause" class="btn btn-secondary">
              <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNOCA1djE0aDN2LTE0ek0xMyA1djE0aDN2LTE0eiIgZmlsbD0id2hpdGUiLz48L3N2Zz4=" class="icon" alt="pause"> Jeda
            </button>
          </div>
        </div>

        <div class="player-container">
          <div class="player-status">
            <div class="status-left">
              <div class="status-icon-wrapper">
                <svg class="status-icon icon-speaker" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z" fill="#2d2d2d"/>
                </svg>
                <svg class="status-icon icon-bell" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                  <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.9 2 2 2zm6-6v-5c0-3.07-1.63-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.64 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2zm-2 1H8v-6c0-2.48 1.51-4.5 4-4.5s4 2.02 4 4.5v6z" fill="#2d2d2d"/>
                </svg>
              </div>
              <div class="status-text">tidak memutar suara i'lan</div>
            </div>
            <div class="auto-mode-toggle">
              <label class="switch">
                <input type="checkbox" id="autoModeToggle" checked>
                <span class="slider round"></span>
              </label>
              <span class="auto-mode-label">Mode Auto</span>
            </div>
            <div class="status-right">
              <div id="ilan-countdown" class="countdown-inline">Menghitung waktu menuju i'lan berikutnya...</div>
            </div>
          </div>
          <audio id="player" controls></audio>
        </div>

        <div class="log-container">
          <div id="audio-log"></div>
        </div>

        <table class="prayer-table">
          <tr>
            <th id="header-fajr">Subuh</th>
            <th id="header-sunrise">Terbit</th>
            <th id="header-dhuhr">Dzuhur</th>
            <th id="header-asr">Ashar</th>
            <th id="header-maghrib">Maghrib</th>
            <th id="header-isha">Isya</th>
          </tr>
          <tr>
            <td id="time-fajr">--:--</td>
            <td id="time-sunrise" class="sunrise">--:--</td>
            <td id="time-dhuhr">--:--</td>
            <td id="time-asr">--:--</td>
            <td id="time-maghrib">--:--</td>
            <td id="time-isha">--:--</td>
          </tr>
        </table>

        <table class="prayer-table" style="margin-top: 30px;">
          <tr>
            <th colspan="2">
              Jadwal Kegiatan
              <button onclick="showAddActivityModal()" class="btn-add-activity">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTkgMTNoLTZ2NmgtMnYtNkg1di0yaDZWNWgydjZoNnYyeiIgZmlsbD0iI0ZGRiIvPjwvc3ZnPg==" class="icon icon-white" alt="add">
              </button>
            </th>
          </tr>
          <tbody id="activity-list">
            <!-- Activities will be dynamically inserted here -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal untuk menambah/edit kegiatan -->
  <div id="activityModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Tambah Kegiatan Baru</h2>
      <form id="activityForm" onsubmit="saveActivity(event)">
        <div class="form-group">
          <label for="activityName">Nama Kegiatan:</label>
          <input type="text" id="activityName" required>
        </div>
        <div class="form-group">
          <label for="activityTime">Waktu (Format 24 Jam):</label>
          <input type="text" 
                 id="activityTime" 
                 required 
                 placeholder="HH:mm (contoh: 14:00)"
                 pattern="([01]?[0-9]|2[0-3]):[0-5][0-9]"
                 maxlength="5"
                 style="font-family: 'Poppins', sans-serif; font-size: 1em;">
        </div>
        <div class="modal-buttons">
          <button type="button" onclick="closeModal()" class="btn-secondary">Batal</button>
          <button type="submit" class="btn-primary">Simpan</button>
        </div>
      </form>
    </div>
  </div>

  <div class="footer">
    <div class="footer-content">
      <img src="logo_bapen.svg" alt="Logo BAPEN" class="footer-logo">
      <div class="footer-text">&copy; Language of Education ISPAH 2025</div>
    </div>
  </div>

  <script>
    // ===== JADWAL SHOLAT & SCHEDULER =====
    let timings = null;
    let prayerTimes = null;
    let tomorrowPrayerTimes = null;
    const audioLog = document.getElementById('audio-log');
    const ilanStatus = document.getElementById('ilan-status');
    let isAutoMode = localStorage.getItem('autoMode') !== 'false'; // Default true

    // Inisialisasi toggle switch
    const autoModeToggle = document.getElementById('autoModeToggle');
    autoModeToggle.checked = isAutoMode;

    // Event listener untuk toggle switch
    autoModeToggle.addEventListener('change', function() {
      isAutoMode = this.checked;
      localStorage.setItem('autoMode', isAutoMode);
      logAudio(`üîÑ Mode auto ${isAutoMode ? 'diaktifkan' : 'dinonaktifkan'}`);
      
      // Toggle visibility countdown dengan class
      const ilanCountdown = document.getElementById('ilan-countdown');
      if (isAutoMode) {
        ilanCountdown.classList.remove('hidden');
      } else {
        ilanCountdown.classList.add('hidden');
        if (window.nextTimer) {
          clearTimeout(window.nextTimer);
          window.nextTimer = null;
        }
      }
    });

    // Inisialisasi visibility countdown berdasarkan mode auto
    document.getElementById('ilan-countdown').classList.toggle('hidden', !isAutoMode);

    async function fetchPrayerTimes() {
      try {
        // Coba ambil dari localStorage dulu
        const cachedTimings = localStorage.getItem('prayerTimings');
        const cachedDate = localStorage.getItem('prayerTimingsDate');
        
        // Jika ada cache dan masih hari yang sama, gunakan cache
        if (cachedTimings && cachedDate === new Date().toDateString()) {
          const parsedTimings = JSON.parse(cachedTimings);
          logAudio('‚úÖ Menggunakan jadwal dari cache');
          return parsedTimings;
        }
        
        // Koordinat Depok
        const latitude = -6.4;
        const longitude = 106.8186;
        
        // Get current date
        const now = new Date();
        const timestamp = Math.floor(now.getTime() / 1000);
        
        // Fetch dari API Aladhan
        const response = await fetch(`https://api.aladhan.com/v1/timings/${timestamp}?latitude=${latitude}&longitude=${longitude}&method=11`);
        
        if (!response.ok) {
          throw new Error('Gagal mengambil data dari API');
        }
        
        const data = await response.json();
        
        if (data && data.data && data.data.timings) {
          const timings = {
            Imsak: data.data.timings.Imsak,
            Fajr: data.data.timings.Fajr,
            Sunrise: data.data.timings.Sunrise,
            Dhuhr: data.data.timings.Dhuhr,
            Asr: data.data.timings.Asr,
            Maghrib: data.data.timings.Maghrib,
            Isha: data.data.timings.Isha,
            Midnight: data.data.timings.Midnight
          };
          
          // Simpan ke localStorage
          localStorage.setItem('prayerTimings', JSON.stringify(timings));
          localStorage.setItem('prayerTimingsDate', new Date().toDateString());
          
          logAudio('‚úÖ Berhasil mengambil jadwal dari API Aladhan');
          return timings;
        } else {
          throw new Error('Format data tidak sesuai');
        }
      } catch (err) {
        logAudio(`‚ùå Error mengambil jadwal: ${err.message}`);
        console.error('Error fetching prayer times:', err);
        
        // Coba ambil dari localStorage meski beda hari sebagai fallback pertama
        const cachedTimings = localStorage.getItem('prayerTimings');
        if (cachedTimings) {
          logAudio('‚ö†Ô∏è Menggunakan jadwal dari cache terakhir');
          return JSON.parse(cachedTimings);
        }
        
        // Fallback ke jadwal statis jika tidak ada cache
        const fallbackTimes = {
          Imsak: '04:31',
          Fajr: '04:41',
          Sunrise: '05:57',
          Dhuhr: '12:01',
          Asr: '15:20',
          Maghrib: '18:00',
          Isha: '19:10',
          Midnight: '00:00'
        };
        
        logAudio('‚ö†Ô∏è Menggunakan jadwal statis sebagai fallback terakhir');
        return fallbackTimes;
      }
    }

    async function initializeScheduler() {
      try {
        if (!timings) {
          logAudio('‚è≥ Menginisialisasi jadwal dari API Aladhan untuk Depok');
          timings = await fetchPrayerTimes();
          
          if (!timings) {
            throw new Error('Gagal mendapatkan jadwal sholat');
          }

          // Initialize prayer times
          const today = new Date();
          const tomorrow = new Date(today);
          tomorrow.setDate(tomorrow.getDate() + 1);
          
          prayerTimes = {
            fajr: convertToDate(timings.Fajr),
            dhuhr: convertToDate(timings.Dhuhr),
            asr: convertToDate(timings.Asr),
            maghrib: convertToDate(timings.Maghrib),
            isha: convertToDate(timings.Isha)
          };

          tomorrowPrayerTimes = {
            fajr: convertToDate(timings.Fajr, tomorrow),
            dhuhr: convertToDate(timings.Dhuhr, tomorrow),
            asr: convertToDate(timings.Asr, tomorrow),
            maghrib: convertToDate(timings.Maghrib, tomorrow),
            isha: convertToDate(timings.Isha, tomorrow)
          };
          
          scheduleAll();
          updatePrayerTable();
          logAudio('‚úÖ Jadwal sholat berhasil dimuat');
        }
        
        updateCountdown();
        updateIlanCountdown();
        
      } catch (err) {
        logAudio(`‚ùå Error: ${err.message}`);
        console.error('Error initializing scheduler:', err);
      }
    }

    // Jalankan scheduler saat halaman dimuat
    window.addEventListener('load', () => {
      initializeScheduler();
      // Update setiap jam untuk antisipasi pergantian hari
      setInterval(initializeScheduler, 1000*60*60);
    });

    // Update jam setiap detik dengan format yang akurat
    function updateClock() {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('id-ID', { 
        hour12: false,
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      }).replace(/\./g, ':');
      
      const dateStr = now.toLocaleDateString('id-ID', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
      
      document.getElementById('clock').textContent = timeStr;
      document.getElementById('date-hijri').textContent = dateStr;
    }
    setInterval(updateClock, 1000);
    updateClock();

    // ===== CALC NEXT PRAYER & COUNTDOWN =====
    function getNextEvent() {
      if(!timings) return null;
      const now = new Date();
      const events = [];
      
      // Konversi waktu sholat ke timestamp hari ini dan besok
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      const prayerTimes = {
        fajr: convertToDate(timings.Fajr),
        dhuhr: convertToDate(timings.Dhuhr),
        asr: convertToDate(timings.Asr),
        maghrib: convertToDate(timings.Maghrib),
        isha: convertToDate(timings.Isha)
      };

      const tomorrowPrayerTimes = {
        fajr: convertToDate(timings.Fajr, tomorrow),
        dhuhr: convertToDate(timings.Dhuhr, tomorrow),
        asr: convertToDate(timings.Asr, tomorrow),
        maghrib: convertToDate(timings.Maghrib, tomorrow),
        isha: convertToDate(timings.Isha, tomorrow)
      };

      // Fungsi untuk menambahkan waktu i'lan
      function addIlanEvents(prayerTime, prayer) {
        // Hanya tambahkan event adzan
        if (prayerTime > now) {
          events.push({
            prayer,
            when: prayerTime,
            type: 'adzan'
          });
        }
      }

      // Tambahkan semua waktu sholat hari ini
      Object.entries(prayerTimes).forEach(([prayer, time]) => {
        addIlanEvents(time, prayer);
      });

      // Jika tidak ada event tersisa hari ini, tambahkan untuk besok
      if (events.length === 0) {
        Object.entries(tomorrowPrayerTimes).forEach(([prayer, time]) => {
          addIlanEvents(time, prayer);
        });
      }

      // Urutkan berdasarkan waktu terdekat
      events.sort((a,b) => a.when - b.when);
      return events[0] || null;
    }

    function getNextIlan() {
      if(!timings) return null;
      const now = new Date();
      const events = [];
      
      const today = new Date();
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      function addIlanTimes(baseTime, prayer) {
        // Waktu i'lan: 15 menit, 10 menit, dan 5 menit sebelum adzan
        const times = [
          { minutes: 15, type: 'awal' },
          { minutes: 10, type: 'tsani' },
          { minutes: 5, type: 'akhir' }
        ];
        
        times.forEach(({ minutes, type }) => {
          const ilanTime = new Date(baseTime.getTime() - minutes * 60000);
          if (ilanTime > now) {
            events.push({
              prayer,
              when: ilanTime,
              type,
              minutes
            });
          }
        });
      }
      
      // Proses waktu hari ini
      if (prayerTimes) {
        Object.entries(prayerTimes).forEach(([prayer, time]) => {
          addIlanTimes(time, prayer);
        });
      }
      
      // Jika tidak ada event hari ini, proses untuk besok
      if (events.length === 0 && tomorrowPrayerTimes) {
        Object.entries(tomorrowPrayerTimes).forEach(([prayer, time]) => {
          addIlanTimes(time, prayer);
        });
      }
      
      // Urutkan berdasarkan waktu terdekat
      events.sort((a,b) => a.when - b.when);
      return events[0] || null;
    }

    function updateCountdown() {
      const next = getNextEvent();
      if (!next) {
        document.getElementById('countdown').textContent = 'Memuat jadwal...';
        return;
      }
      
      const diff = next.when - new Date();
      const s = Math.floor((diff%60000)/1000);
      const m = Math.floor((diff/60000)%60);
      const h = Math.floor(diff/3600000);
      
      const prayerNames = {
        fajr: 'Subuh',
        dhuhr: 'Dzuhur',
        asr: 'Ashar',
        maghrib: 'Maghrib',
        isha: 'Isya'
      };

      let countdownStr = '';
      if (h > 0) {
        countdownStr = `${h} jam ${m} menit ${s} detik`;
      } else if (m > 0) {
        countdownStr = `${m} menit ${s} detik`;
      } else {
        countdownStr = `${s} detik`;
      }

      document.getElementById('countdown').textContent =
        `${countdownStr} menuju adzan ${prayerNames[next.prayer]}`;
    }

    function updateIlanCountdown() {
      const nextIlan = getNextIlan();
      if (!nextIlan) {
        document.getElementById('ilan-countdown').textContent = 'Menghitung waktu menuju i\'lan berikutnya...';
        return;
      }
      
      const diff = nextIlan.when - new Date();
      const s = Math.floor((diff%60000)/1000);
      const m = Math.floor((diff/60000)%60);
      const h = Math.floor(diff/3600000);
      
      const prayerNames = {
        fajr: 'Subuh',
        dhuhr: 'Dzuhur',
        asr: 'Ashar',
        maghrib: 'Maghrib',
        isha: 'Isya'
      };

      // Format waktu dalam bentuk teks deskriptif
      let countdownStr = '';
      if (h > 0) {
        countdownStr = `${h} jam ${m} menit ${s} detik`;
      } else if (m > 0) {
        countdownStr = `${m} menit ${s} detik`;
      } else {
        countdownStr = `${s} detik`;
      }

      document.getElementById('ilan-countdown').textContent =
        `${countdownStr} menuju i'lan ${nextIlan.type} ${prayerNames[nextIlan.prayer]}`;
    }

    // Update countdown setiap 100ms untuk animasi yang lebih halus
    setInterval(() => {
      updateCountdown();
      updateIlanCountdown();
      checkAndPlayScheduledIlan();
    }, 100);

    // Modifikasi scheduleAll untuk menangani i'lan otomatis
    function scheduleAll() {
      try {
        if (!isAutoMode) return; // Tambahkan pengecekan mode auto
        
        const nextIlan = getNextIlan();
        if (!nextIlan) return;
        
        // clear existing timers
        if (window.nextTimer) clearTimeout(window.nextTimer);
        
        const delay = nextIlan.when - new Date();
        
        // Jangan schedule jika delay negatif (sudah lewat)
        if (delay < 0) return;
        
        window.nextTimer = setTimeout(() => {
          try {
            if (!isAutoMode) return; // Cek lagi sebelum memutar
            
            // Putar audio secara otomatis saat waktunya tiba
            playAudio('alfatih', nextIlan.prayer, nextIlan.type);
            
            // Schedule untuk i'lan berikutnya setelah jeda
            setTimeout(scheduleAll, 2000); // Tunggu 2 detik sebelum schedule berikutnya
          } catch (err) {
            console.error('Error in scheduled playback:', err);
            logAudio(`‚ùå Error pada pemutaran otomatis: ${err.message}`);
            // Coba schedule ulang setelah error
            setTimeout(scheduleAll, 5000);
          }
        }, delay);

        // Konversi delay ke format yang lebih mudah dibaca
        const totalMinutes = Math.floor(delay/60000);
        const hours = Math.floor(totalMinutes/60);
        const minutes = totalMinutes % 60;
        const seconds = Math.floor((delay%60000)/1000);

        let timeStr = '';
        if (hours > 0) {
          timeStr = `${hours} jam ${minutes} menit ${seconds} detik`;
        } else if (minutes > 0) {
          timeStr = `${minutes} menit ${seconds} detik`;
        } else {
          timeStr = `${seconds} detik`;
        }

        logAudio(`‚è∞ Dijadwalkan memutar i'lan ${nextIlan.type} ${nextIlan.prayer} dalam ${timeStr}`);
      } catch (err) {
        console.error('Error in scheduleAll:', err);
        logAudio(`‚ùå Error pada penjadwalan: ${err.message}`);
        // Coba schedule ulang setelah error
        setTimeout(scheduleAll, 5000);
      }
    }

    // Panggil scheduleAll setiap kali ada perubahan jadwal
    window.addEventListener('load', () => {
      initializeScheduler();
      // Update setiap 30 menit untuk antisipasi perubahan jadwal
      setInterval(initializeScheduler, 1000*60*30);
    });

    // Tambahkan variabel untuk mengontrol pemutaran
    let isPlaying = false;
    let audioQueue = [];
    let currentBellPlayer = null;

    async function playBell() {
      return new Promise((resolve, reject) => {
        try {
          if (currentBellPlayer) {
            currentBellPlayer.pause();
            currentBellPlayer = null;
          }

          const bellPlayer = new Audio('audio/ting tung ning nung.MP3');
          currentBellPlayer = bellPlayer;
          bellPlayer.volume = 1;

          // Update status untuk bell
          const statusText = document.querySelector('.status-text');
          const playerStatus = document.querySelector('.player-status');
          
          if (statusText) {
            statusText.textContent = 'memutar audio bell';
            statusText.style.color = '#ffb700';
          }
          if (playerStatus) {
            playerStatus.classList.remove('playing');
            playerStatus.classList.add('bell');
          }

          bellPlayer.onended = () => {
            currentBellPlayer = null;
            // Reset status setelah bell selesai
            if (playerStatus) {
              playerStatus.classList.remove('bell');
            }
            resolve();
          };

          bellPlayer.onerror = (err) => {
            currentBellPlayer = null;
            reject(err);
          };

          bellPlayer.play();
        } catch (err) {
          currentBellPlayer = null;
          reject(err);
        }
      });
    }

    async function playAudio(member='alfatih', prayer='maghrib', type='tsani') {
      // Log parameter yang diterima
      console.log('playAudio dipanggil dengan:', { member, prayer, type });
      if (isPlaying) {
        logAudio('‚è≥ Menunggu audio sebelumnya selesai...');
        return;
      }

      isPlaying = true;
      try {
        // Reset audio state
        if (player) {
          player.pause();
          player.currentTime = 0;
          player.src = ''; // Clear previous source
        }

        // Validasi parameter
        if (!member || !prayer) {
          throw new Error('Parameter tidak lengkap');
        }

        // Update status sebelum mencoba memutar
        updateIlanStatus(member, prayer, type);

        // Tentukan nama file secara manual untuk setiap kondisi
        let fileName = '';
        
        // Cek untuk alfatih
        if (member === 'alfatih') {
          // Cek untuk isya akhir
          if (prayer === 'isha' && type === 'akhir') {
            fileName = 'alfatih_ilan_isya_akhir.MP3';
          }
          // Cek untuk akhir sholat lainnya
          else if (type === 'akhir') {
            fileName = 'alfatih_ilan_akhir.MP3';
          }
          // Cek untuk shubuh
          else if (prayer === 'fajr' && type === 'awal') {
            fileName = 'alfatih_ilan_shubuh_awal.MP3';
          }
          else if (prayer === 'fajr' && type === 'tsani') {
            fileName = 'alfatih_ilan_shubuh_tsani.MP3';
          }
          // Cek untuk dzuhur
          else if (prayer === 'dhuhr' && type === 'awal') {
            fileName = 'alfatih_ilan_dzuhur_awal.MP3';
          }
          else if (prayer === 'dhuhr' && type === 'tsani') {
            fileName = 'alfatih_ilan_dzuhur_tsani.MP3';
          }
          // Cek untuk ashar
          else if (prayer === 'asr' && type === 'awal') {
            fileName = 'alfatih_ilan_ashar_awal.MP3';
          }
          else if (prayer === 'asr' && type === 'tsani') {
            fileName = 'alfatih_ilan_ashar_tsani.MP3';
          }
          // Cek untuk maghrib
          else if (prayer === 'maghrib' && type === 'awal') {
            fileName = 'alfatih_ilan_maghrib_awal.MP3';
          }
          else if (prayer === 'maghrib' && type === 'tsani') {
            fileName = 'alfatih_ilan_maghrib_tsani.MP3';
          }
          // Cek untuk isya
          else if (prayer === 'isha' && type === 'awal') {
            fileName = 'alfatih_ilan_isya_awal.MP3';
          }
          
          // Jika tidak ada yang cocok
          if (!fileName) {
            throw new Error(`Kombinasi prayer '${prayer}' dan type '${type}' tidak valid`);
          }
        } else {
          throw new Error(`Audio untuk ${member} belum tersedia`);
        }

        // Pastikan format nama file sudah benar
        logAudio(`‚ÑπÔ∏è Parameter: member=${member}, prayer=${prayer}, type=${type}`);
        logAudio(`‚ÑπÔ∏è Nama file yang akan dicari: ${fileName}`);
        
        // Path lengkap ke file audio
        const audioPath = `audio/ilan/alfatih/${fileName}`;
        logAudio(`üîç Mencari file: ${window.location.href}${audioPath}`);
        logAudio(`‚ÑπÔ∏è Path lengkap: ${window.location.origin}/${audioPath}`);
        logAudio(`‚ÑπÔ∏è Path relatif dari root: ${audioPath}`);
        logAudio(`üìÇ Mencari file: ${audioPath}`);
        logAudio(`üìÅ Direktori kerja: ${window.location.href}`);
        
        // Cek apakah file ada
        try {
          const response = await fetch(audioPath, { method: 'HEAD' });
          if (!response.ok) {
            throw new Error('File tidak ditemukan');
          }
          logAudio('‚úÖ File ditemukan dan dapat diakses');
        } catch (err) {
          logAudio(`‚ùå File tidak dapat diakses: ${err.message}`);
        }
        
        try {
          // Tunggu 500ms sebelum memutar bell pertama
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Putar bell pertama
          logAudio('üîî Memutar bell pembuka...');
          await playBell();
          
          // Tunggu 500ms sebelum memutar i'lan
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Set source untuk i'lan
          player.src = audioPath;
          player.controls = true;
          player.volume = 1;
          player.muted = false;

          // Reset onended handler
          const playPromise = new Promise((resolve, reject) => {
            player.onended = resolve;
            player.onerror = reject;
          });

          // Putar i'lan
          await player.play();
          logAudio(`‚úÖ Berhasil memutar i'lan ${type} ${prayer} - ${member}`);
          
          // Tunggu sampai i'lan selesai
          await playPromise;
          
          // Tunggu 500ms sebelum memutar bell penutup
          await new Promise(resolve => setTimeout(resolve, 500));
          
          // Putar bell penutup
          logAudio('üîî Memutar bell penutup...');
          await playBell();
          
          // Reset status
          logAudio('‚úÖ Selesai memutar seluruh rangkaian audio');
        } catch (playError) {
          logAudio(`‚ùå Gagal memutar audio: ${playError.message}`);
          throw playError; // Re-throw error untuk ditangkap oleh catch luar
        }
      } catch (err) {
        logAudio(`‚ùå Error: ${err.message}`);
        // Jangan lupa reset status jika ada error
        updateIlanStatus();
        throw err; // Re-throw error untuk penanganan lebih lanjut jika diperlukan
      } finally {
        // Pastikan status selalu direset dan isPlaying di-set ke false
        isPlaying = false;
        updateIlanStatus();
        // Reset player state
        if (player) {
          player.pause();
          player.currentTime = 0;
          player.src = '';
        }
      }
    }

    function checkAndPlayScheduledIlan() {
      if (!isAutoMode || isPlaying) return; // Tambahkan pengecekan mode auto
      
      const nextIlan = getNextIlan();
      if (!nextIlan) return;
      
      const now = new Date();
      const timeDiff = nextIlan.when - now;
      
      // Jika sudah waktunya atau terlambat maksimal 5 detik
      if (timeDiff <= 5000 && timeDiff >= -5000) {
        // Tambahkan pengecekan tambahan untuk mencegah pemutaran ganda
        const lastPlayTime = localStorage.getItem('lastPlayTime');
        const currentTime = now.getTime();
        
        // Jika belum ada catatan pemutaran atau sudah lebih dari 1 menit dari pemutaran terakhir
        if (!lastPlayTime || (currentTime - parseInt(lastPlayTime)) > 60000) {
          localStorage.setItem('lastPlayTime', currentTime.toString());
          playAudio('alfatih', nextIlan.prayer, nextIlan.type);
          logAudio(`üîÑ Memulai pemutaran otomatis untuk i'lan ${nextIlan.type} ${nextIlan.prayer}`);
        }
      }
    }

    // ===== AUDIO & VISUALIZER =====
    function logAudio(msg) {
      const audioLog = document.getElementById('audio-log');
      const logLine = document.createElement('div');
      logLine.className = 'log-message';
      
      // Format timestamp dalam bentuk teks deskriptif
      const now = new Date();
      const hours = now.getHours();
      const minutes = now.getMinutes();
      const seconds = now.getSeconds();
      
      // Format jam dengan "pagi/siang/sore/malam"
      let timeOfDay = '';
      if (hours >= 3 && hours < 11) timeOfDay = 'pagi';
      else if (hours >= 11 && hours < 15) timeOfDay = 'siang';
      else if (hours >= 15 && hours < 18) timeOfDay = 'sore';
      else timeOfDay = 'malam';
      
      const timestamp = `${hours}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')} ${timeOfDay}`;
      
      // Menentukan tipe pesan
      if (msg.includes('‚úÖ')) {
        logLine.className += ' success';
      } else if (msg.includes('‚ùå')) {
        logLine.className += ' error';
      } else if (msg.includes('‚ö†Ô∏è')) {
        logLine.className += ' warning';
      }
      
      logLine.innerHTML = `<span style="color:#666;font-size:0.9em">[${timestamp}]</span> ${msg}`;
      audioLog.appendChild(logLine);
      audioLog.scrollTop = audioLog.scrollHeight;
    }

    function updateIlanStatus(member = '', prayer = '', type = '') {
      const statusText = document.querySelector('.status-text');
      const playerStatus = document.querySelector('.player-status');
      
      if (!player.src || player.paused) {
        if (statusText) {
          statusText.textContent = 'tidak memutar suara i\'lan';
          statusText.style.color = '#ff3333';
        }
        if (playerStatus) {
          playerStatus.classList.remove('playing');
          playerStatus.classList.remove('bell');
        }
        return;
      }

      // Mapping nama yang lebih baik untuk ditampilkan
      const memberNames = {
        alfatih: 'Al-Fatih',
        imam: 'Imam',
        udin: 'Udin',
        gusti: 'Gusti',
        danish: 'Danish',
        feyrzan: 'Feyrzan'
      };

      const prayerNames = {
        fajr: 'Subuh',
        dhuhr: 'Dzuhur',
        asr: 'Ashar',
        maghrib: 'Maghrib',
        isha: 'Isya'
      };

      const typeNames = {
        awal: 'Awal',
        tsani: 'Tsani',
        akhir: 'Akhir'
      };

      // Dapatkan nama yang sesuai atau gunakan nilai default jika tidak ada
      const displayMember = memberNames[member] || member;
      const displayPrayer = prayerNames[prayer] || prayer;
      const displayType = typeNames[type] || type;

      // Format status text dan update class untuk icon
      if (member && prayer && type) {
        if (statusText) {
          statusText.textContent = `sedang memutar i'lan ${displayType} ${displayPrayer} - ${displayMember}`;
          statusText.style.color = '#00c853';
        }
        if (playerStatus) {
          playerStatus.classList.add('playing');
          playerStatus.classList.remove('bell');
        }
      } else {
        // Status default saat tidak ada info lengkap
        if (!player.paused) {
          if (statusText) {
            statusText.textContent = 'sedang memutar suara i\'lan';
            statusText.style.color = '#00c853';
          }
          if (playerStatus) {
            playerStatus.classList.add('playing');
            playerStatus.classList.remove('bell');
          }
        } else {
          if (statusText) {
            statusText.textContent = 'tidak memutar suara i\'lan';
            statusText.style.color = '#ff3333';
          }
          if (playerStatus) {
            playerStatus.classList.remove('playing');
            playerStatus.classList.remove('bell');
          }
        }
      }
    }

    // Event listeners untuk audio dengan error handling yang lebih baik
    player.addEventListener('play', () => {
      try {
        const audioSrc = player.src;
        // Parse informasi dari nama file
        const match = audioSrc.match(/ilan\s+(subuh|dzuhur|ashar|magrib|isya|akhir)\s*(awal|tsani|akhir)?/i);
        
        if (match) {
          const prayerMap = {
            'subuh': 'fajr',
            'dzuhur': 'dhuhr',
            'ashar': 'asr',
            'magrib': 'maghrib',
            'isya': 'isha'
          };

          const prayer = prayerMap[match[1].toLowerCase()] || match[1];
          const type = (match[2] || 'akhir').toLowerCase();
          updateIlanStatus('alfatih', prayer, type);
        } else {
          // Jika tidak bisa parse info dari nama file, tampilkan status default
          updateIlanStatus();
        }
        logAudio('‚ñ∂Ô∏è Audio mulai bermain');
      } catch (err) {
        console.error('Error in play handler:', err);
        updateIlanStatus();
      }
    });

    player.addEventListener('pause', () => {
      try {
        updateIlanStatus();
        logAudio('‚è∏Ô∏è Audio dipause');
      } catch (err) {
        console.error('Error in pause handler:', err);
      }
    });

    player.addEventListener('ended', () => {
      try {
        updateIlanStatus();
        logAudio('‚èπÔ∏è Audio selesai');
      } catch (err) {
        console.error('Error in ended handler:', err);
      }
    });

    player.addEventListener('error', (e) => {
      try {
        const error = e.target.error;
        let errorMessage = 'Terjadi kesalahan saat memutar audio';
        
        if (error) {
          switch (error.code) {
            case error.MEDIA_ERR_ABORTED:
              errorMessage = 'Pemutaran audio dibatalkan';
              break;
            case error.MEDIA_ERR_NETWORK:
              errorMessage = 'Terjadi kesalahan jaringan';
              break;
            case error.MEDIA_ERR_DECODE:
              errorMessage = 'Format audio tidak didukung';
              break;
            case error.MEDIA_ERR_SRC_NOT_SUPPORTED:
              errorMessage = 'File audio tidak ditemukan atau tidak didukung';
              break;
          }
        }
        
        logAudio(`‚ùå ${errorMessage}`);
        updateIlanStatus();
      } catch (err) {
        console.error('Error in error handler:', err);
      }
    });

    // Manual controls
    document.getElementById('btnPlay').onclick = () => {
      const m = document.getElementById('member').value;
      const p = document.getElementById('prayer').value;
      const t = document.getElementById('type').value;
      if(!m||!p||!t) return alert("Pilih anggota, waktu, & jenis i'lan dulu!");
      playAudio(m,p,t);
    };
    
    document.getElementById('btnPause').onclick = () => player.pause();

    // Fungsi untuk update tabel jadwal
    function getCurrentPrayer() {
      if (!timings) return null;
      const now = new Date();
      
      // Konversi waktu sholat ke timestamp hari ini
      const prayerTimes = {
        fajr: convertToDate(timings.Fajr),
        sunrise: convertToDate(timings.Sunrise),
        dhuhr: convertToDate(timings.Dhuhr),
        asr: convertToDate(timings.Asr),
        maghrib: convertToDate(timings.Maghrib),
        isha: convertToDate(timings.Isha)
      };

      // Urutkan waktu sholat
      const orderedPrayers = Object.entries(prayerTimes).sort((a, b) => a[1] - b[1]);
      
      // Cari waktu sholat yang sedang berlangsung
      for (let i = orderedPrayers.length - 1; i >= 0; i--) {
        if (now >= orderedPrayers[i][1]) {
          // Khusus untuk subuh, cek apakah sudah terbit
          if (orderedPrayers[i][0] === 'fajr') {
            const sunriseTime = prayerTimes.sunrise;
            if (now >= sunriseTime) {
              return 'sunrise';
            }
          }
          // Tambahkan logika untuk sunrise saat dzuhur
          if (orderedPrayers[i][0] === 'dhuhr' || orderedPrayers[i][0] === 'asr' || 
              orderedPrayers[i][0] === 'maghrib' || orderedPrayers[i][0] === 'isha') {
            document.getElementById('time-sunrise').style.background = '#fff';
          }
          return orderedPrayers[i][0];
        }
      }
      
      // Jika sekarang sebelum subuh, cek apakah setelah isya hari sebelumnya
      const yesterdayIsha = new Date(now);
      yesterdayIsha.setDate(yesterdayIsha.getDate() - 1);
      const ishaTime = convertToDate(timings.Isha, yesterdayIsha);
      
      if (now >= ishaTime) {
        return 'isha';
      }
      
      // Jika tidak dalam kondisi apapun di atas, kembalikan waktu sholat terakhir
      return orderedPrayers[orderedPrayers.length - 1][0];
    }

    function updatePrayerTable() {
      if (!timings) return;
      
      document.getElementById('time-fajr').textContent = timings.Fajr;
      document.getElementById('time-sunrise').textContent = timings.Sunrise;
      document.getElementById('time-dhuhr').textContent = timings.Dhuhr;
      document.getElementById('time-asr').textContent = timings.Asr;
      document.getElementById('time-maghrib').textContent = timings.Maghrib;
      document.getElementById('time-isha').textContent = timings.Isha;

      // Reset warna sunrise ke default
      const now = new Date();
      const dhuhrTime = convertToDate(timings.Dhuhr);
      if (now < dhuhrTime) {
        document.getElementById('time-sunrise').style.background = '#ffe4b3';
      }

      // Reset semua highlight
      const timeElements = ['fajr', 'sunrise', 'dhuhr', 'asr', 'maghrib', 'isha'];
      timeElements.forEach(prayer => {
        const elementId = `time-${prayer}`;
        const headerElementId = `header-${prayer}`;
        if (document.getElementById(elementId)) {
          document.getElementById(elementId).classList.remove('active');
        }
        if (document.getElementById(headerElementId)) {
          document.getElementById(headerElementId).classList.remove('active');
        }
      });

      // Tandai waktu yang sedang berlangsung
      const currentPrayer = getCurrentPrayer();
      if (currentPrayer) {
        const elementId = `time-${currentPrayer}`;
        const headerElementId = `header-${currentPrayer}`;
        const timeElement = document.getElementById(elementId);
        const headerElement = document.getElementById(headerElementId);
        
        if (timeElement) {
          timeElement.classList.add('active');
        }
        if (headerElement) {
          headerElement.classList.add('active');
        }
      }
    }

    // Update tabel setiap 30 detik untuk memastikan perpindahan tanda yang mulus
    setInterval(updatePrayerTable, 30000);

    // Fungsi untuk membersihkan log
    function clearLog() {
      const audioLog = document.getElementById('audio-log');
      const clearMessage = document.createElement('div');
      clearMessage.className = 'log-message success';
      clearMessage.innerHTML = '<span>‚ú® Log dibersihkan</span>';
      audioLog.innerHTML = '';
      audioLog.appendChild(clearMessage);
      setTimeout(() => {
        audioLog.innerHTML = '';
      }, 1000);
    }

    // Fungsi utilitas untuk konversi waktu
    function convertToDate(timeStr, baseDate = new Date()) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      const date = new Date(baseDate);
      date.setHours(hours, minutes, 0, 0);
      return date;
    }

    // ===== ACTIVITY MANAGEMENT =====
    let activities = JSON.parse(localStorage.getItem('activities')) || [{
      name: 'Apel / Dhuha',
      time: '06:30'
    }];

    function showAddActivityModal() {
      const modal = document.getElementById('activityModal');
      const form = document.getElementById('activityForm');
      
      // Reset form
      document.getElementById('modalTitle').textContent = 'Tambah Kegiatan Baru';
      document.getElementById('activityName').value = '';
      document.getElementById('activityTime').value = '';
      delete form.dataset.editIndex;
      
      modal.classList.add('show');
      document.getElementById('activityName').focus();
    }

    function editActivity(button) {
      const modal = document.getElementById('activityModal');
      const form = document.getElementById('activityForm');
      const index = button.closest('tr').dataset.index;
      const activity = activities[index];
      
      if (!activity) return;
      
      document.getElementById('modalTitle').textContent = 'Edit Kegiatan';
      document.getElementById('activityName').value = activity.name;
      document.getElementById('activityTime').value = activity.time;
      form.dataset.editIndex = index;
      
      modal.classList.add('show');
      document.getElementById('activityName').focus();
    }

    function closeModal() {
      const modal = document.getElementById('activityModal');
      modal.classList.remove('show');
    }

    function deleteActivity(button) {
      const row = button.closest('tr');
      const index = parseInt(row.dataset.index);
      
      if (confirm('Yakin ingin menghapus kegiatan ini?')) {
        try {
          activities.splice(index, 1);
          saveActivitiesToStorage();
          renderActivities();
          showToast('Kegiatan berhasil dihapus', 'success');
        } catch (error) {
          console.error('Error deleting activity:', error);
          showToast('Gagal menghapus kegiatan', 'error');
        }
      }
    }

    function validateTime(timeStr) {
      // Format regex untuk waktu 24 jam (00:00 - 23:59)
      const timeRegex = /^([01]?[0-9]|2[0-3]):[0-5][0-9]$/;
      if (!timeRegex.test(timeStr)) {
        return false;
      }
      
      const [hours, minutes] = timeStr.split(':').map(Number);
      return hours >= 0 && hours <= 23 && minutes >= 0 && minutes <= 59;
    }

    function formatTime(timeStr) {
      const [hours, minutes] = timeStr.split(':').map(Number);
      return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
    }

    function saveActivity(event) {
      event.preventDefault();
      
      const form = event.target;
      const submitBtn = form.querySelector('button[type="submit"]');
      setLoading(submitBtn, true);
      
      try {
        const name = document.getElementById('activityName').value;
        const timeInput = document.getElementById('activityTime');
        let time = timeInput.value;
        
        // Pastikan format waktu valid
        if (!time) {
          showToast('Waktu harus diisi', 'error');
          return;
        }
        
        const editIndex = form.dataset.editIndex;
        
        if (editIndex !== undefined) {
          activities[editIndex] = { name, time };
          delete form.dataset.editIndex;
          showToast('Kegiatan berhasil diperbarui', 'success');
        } else {
          activities.push({ name, time });
          showToast('Kegiatan baru berhasil ditambahkan', 'success');
        }
        
        // Sort berdasarkan waktu 24 jam
        activities.sort((a, b) => {
          const [hoursA, minutesA] = a.time.split(':').map(Number);
          const [hoursB, minutesB] = b.time.split(':').map(Number);
          return (hoursA * 60 + minutesA) - (hoursB * 60 + minutesB);
        });
        
        saveActivitiesToStorage();
        renderActivities();
        closeModal();
      } catch (error) {
        console.error('Error saving activity:', error);
        showToast('Gagal menyimpan kegiatan', 'error');
      } finally {
        setLoading(submitBtn, false);
      }
    }

    async function deleteActivity(button) {
      if (confirm('Yakin ingin menghapus kegiatan ini?')) {
        const item = button.closest('.activity-item');
        setLoading(item, true);
        
        try {
          const index = item.dataset.index;
          activities.splice(index, 1);
          saveActivitiesToStorage();
          renderActivities();
          showToast('Kegiatan berhasil dihapus', 'success');
        } catch (error) {
          console.error('Error deleting activity:', error);
          showToast('Gagal menghapus kegiatan', 'error');
          setLoading(item, false);
        }
      }
    }

    // Audio Player Management
    function updatePlayerStatus(status, type = '') {
      const playerStatus = document.querySelector('.player-status');
      const statusText = playerStatus.querySelector('.status-text');
      
      playerStatus.className = 'player-status';
      if (status === 'playing') {
        playerStatus.classList.add('playing');
        statusText.textContent = type === 'bell' ? 'memutar bell' : 'memutar i\'lan';
      } else if (status === 'bell') {
        playerStatus.classList.add('bell');
        statusText.textContent = 'memutar bell';
      } else {
        statusText.textContent = 'tidak memutar suara i\'lan';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      renderActivities();
      
      // Auto Mode Toggle
      const autoModeToggle = document.getElementById('autoModeToggle');
      autoModeToggle.addEventListener('change', () => {
        const status = autoModeToggle.checked ? 'aktif' : 'nonaktif';
        showToast(`Mode otomatis ${status}`, 'success');
      });
      
      // Player Controls
      const btnPlay = document.getElementById('btnPlay');
      const btnPause = document.getElementById('btnPause');
      
      btnPlay.addEventListener('click', () => {
        updatePlayerStatus('playing');
        showToast('Memulai pemutaran i\'lan', 'success');
      });
      
      btnPause.addEventListener('click', () => {
        updatePlayerStatus('stopped');
        showToast('Menghentikan pemutaran i\'lan', 'success');
      });
    });

    // Tambahkan event listener untuk memastikan format 24 jam
    document.addEventListener('DOMContentLoaded', function() {
      const timeInput = document.getElementById('activityTime');
      if (timeInput) {
        timeInput.addEventListener('input', function(e) {
          let value = e.target.value;
          if (value.includes('AM') || value.includes('PM')) {
            e.preventDefault();
            showToast('Gunakan format 24 jam (00:00 - 23:59)', 'error');
          }
        });
      }
    });

    // ... existing JavaScript code ...

    function saveActivitiesToStorage() {
      try {
        localStorage.setItem('activities', JSON.stringify(activities));
      } catch (error) {
        console.error('Error saving to localStorage:', error);
        showToast('Gagal menyimpan ke localStorage', 'error');
      }
    }

    function renderActivities() {
      const container = document.getElementById('activity-list');
      container.innerHTML = '';
      
      activities.forEach((activity, index) => {
        const row = document.createElement('tr');
        row.className = 'activity-item';
        row.dataset.index = index;
        
        row.innerHTML = `
          <td>${activity.name}</td>
          <td>${activity.time}</td>
          <td style="text-align: right">
            <button onclick="editActivity(this)" class="btn btn-icon">
              <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMyAxNy4yNVYyMWgzLjc1TDE3LjgxIDkuOTRsLTMuNzUtMy43NUwzIDE3LjI1ek0yMC43MSA3LjA0YTEgMSAwIDAwMC0xLjQxbC0yLjM0LTIuMzRhMSAxIDAgMDAtMS40MSAwbC0xLjgzIDEuODMgMy43NSAzLjc1IDEuODMtMS44M3oiIGZpbGw9IiM2NjYiLz48L3N2Zz4=" class="icon" alt="edit">
            </button>
            <button onclick="deleteActivity(this)" class="btn btn-icon">
              <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNiAxOWMwIDEuMS45IDIgMiAyaDhjMS4xIDAgMi0uOSAyLTJWN0g2djEyek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDV2MmgxNFY0eiIgZmlsbD0iI2Y0NDMzNiIvPjwvc3ZnPg==" class="icon" alt="delete">
            </button>
          </td>
        `;
        
        container.appendChild(row);
      });
    }

    function showToast(message, type = 'success') {
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }

    function setLoading(element, isLoading) {
      if (isLoading) {
        element.classList.add('loading');
        element.disabled = true;
      } else {
        element.classList.remove('loading');
        element.disabled = false;
      }
    }
  </script>
  
  <script>
    // Data for dynamic dropdowns
    const siaranFiles = {
      arab: [
        { name: 'Siaran 1', value: 'siaran1' },
        { name: 'Siaran 2', value: 'siaran2' },
        { name: 'Siaran 3', value: 'siaran3' }
      ],
      inggris: [
        { name: 'Broadcast 1', value: 'broadcast1' },
        { name: 'Broadcast 2', value: 'broadcast2' },
        { name: 'Broadcast 3', value: 'broadcast3' }
      ]
    };

    const surahList = {
      subuh: [
        { name: 'Surah Yasin', value: 'yasin' },
        { name: 'Surah Ar-Rahman', value: 'ar-rahman' },
        { name: 'Surah Al-Mulk', value: 'al-mulk' }
      ],
      ashar: [
        { name: 'Surah Al-Kahf', value: 'al-kahf' },
        { name: 'Surah Al-Waqiah', value: 'al-waqiah' },
        { name: 'Surah Ya-Sin', value: 'ya-sin' }
      ]
    };

    // DOM Elements
    const contentTypeSelect = document.getElementById('contentType');
    const ilanFields = document.getElementById('ilan-fields');
    const siaranFields = document.getElementById('siaran-fields');
    const murottalFields = document.getElementById('murottal-fields');
    const bahasaSelect = document.getElementById('bahasa');
    const siaranFileSelect = document.getElementById('siaran-file');
    const waktuMurottalSelect = document.getElementById('waktu-murottal');
    const surahSelect = document.getElementById('surah');
    const playButton = document.getElementById('btnPlay');
    const player = document.getElementById('player');

    // Event Listeners
    document.addEventListener('DOMContentLoaded', function() {
      // Content Type Change
      if (contentTypeSelect) {
        contentTypeSelect.addEventListener('change', handleContentTypeChange);
      }
      
      // Bahasa Change (for Siaran)
      if (bahasaSelect) {
        bahasaSelect.addEventListener('change', handleBahasaChange);
      }
      
      // Waktu Murottal Change
      if (waktuMurottalSelect) {
        waktuMurottalSelect.addEventListener('change', handleWaktuMurottalChange);
      }
      
      // Play Button Click
      if (playButton) {
        playButton.addEventListener('click', handlePlayClick);
      }
    });

    // Event Handlers
    function handleContentTypeChange() {
      // Hide all fields first
      const allFields = document.querySelectorAll('.content-fields');
      allFields.forEach(function(el) {
        if (el && el.style) {
          el.style.display = 'none';
        }
      });

      // Show selected content type fields
      const selectedType = contentTypeSelect ? contentTypeSelect.value : '';
      
      if (selectedType === 'ilan' && ilanFields) {
        ilanFields.style.display = 'block';
      } else if (selectedType === 'siaran' && siaranFields && siaranFileSelect) {
        siaranFields.style.display = 'block';
        // Reset and disable file select until language is chosen
        siaranFileSelect.disabled = true;
        siaranFileSelect.innerHTML = '<option value="">Pilih File Siaran</option>';
      } else if (selectedType === 'murottal' && murottalFields && surahSelect) {
        murottalFields.style.display = 'block';
        // Reset and disable surah select until waktu is chosen
        surahSelect.disabled = true;
        surahSelect.innerHTML = '<option value="">Pilih Surah</option>';
      }
    }

    function handleBahasaChange() {
      if (!bahasaSelect || !siaranFileSelect) return;
      
      const selectedBahasa = bahasaSelect.value;
      const files = siaranFiles[selectedBahasa] || [];
      
      // Clear and repopulate file select
      siaranFileSelect.innerHTML = '<option value="">Pilih File Siaran</option>';
      
      if (files.length > 0) {
        files.forEach(function(file) {
          const option = document.createElement('option');
          option.value = file.value;
          option.textContent = file.name;
          siaranFileSelect.appendChild(option);
        });
        siaranFileSelect.disabled = false;
      } else {
        siaranFileSelect.disabled = true;
      }
    }

    function handleWaktuMurottalChange() {
      if (!waktuMurottalSelect || !surahSelect) return;
      
      const selectedWaktu = waktuMurottalSelect.value;
      const surahs = surahList[selectedWaktu] || [];
      
      // Clear and repopulate surah select
      surahSelect.innerHTML = '<option value="">Pilih Surah</option>';
      
      if (surahs.length > 0) {
        surahs.forEach(function(surah) {
          const option = document.createElement('option');
          option.value = surah.value;
          option.textContent = surah.name;
          surahSelect.appendChild(option);
        });
        surahSelect.disabled = false;
      } else {
        surahSelect.disabled = true;
      }
    }

    async function handlePlayClick() {
      if (!contentTypeSelect) return;
      
      const contentType = contentTypeSelect.value;
      
      if (!contentType) {
        alert('Silakan pilih jenis konten terlebih dahulu');
        return;
      }

      try {
        if (contentType === 'ilan') {
          const member = document.getElementById('member') ? document.getElementById('member').value : '';
          let prayer = document.getElementById('prayer') ? document.getElementById('prayer').value : '';
          // Map prayer names to match file naming
          if (prayer === 'subuh') prayer = 'shubuh';
          const type = document.getElementById('type') ? document.getElementById('type').value : '';
          
          if (!member || !prayer || !type) {
            alert('Silakan lengkapi semua pilihan untuk I\'lan');
            return;
          }
          
          // Play bell start
          await playBell('start');
          
          // Play the announcement
          const audioPath = `audio/ilan/${member}/${member}_ilan_${prayer}_${type}.MP3`;
          await playAudioFile(audioPath);
          
          // Play bell end
          await playBell('end');
          
        } else if (contentType === 'siaran') {
          const bahasa = bahasaSelect ? bahasaSelect.value : '';
          const file = siaranFileSelect ? siaranFileSelect.value : '';
          
          if (!bahasa || !file) {
            alert('Silakan pilih bahasa dan file siaran');
            return;
          }
          
          const audioPath = `audio/siaran/${bahasa}/${file}.mp3`;
          await playAudioFile(audioPath);
          
        } else if (contentType === 'murottal') {
          const waktu = waktuMurottalSelect ? waktuMurottalSelect.value : '';
          const surah = surahSelect ? surahSelect.value : '';
          
          if (!waktu || !surah) {
            alert('Silakan pilih waktu dan surah');
            return;
          }
          
          const audioPath = `audio/murottal/${waktu}/${surah}.mp3`;
          await playAudioFile(audioPath);
        }
        
        updatePlayerStatus(`Memutar ${contentType}...`);
      } catch (error) {
        console.error('Error playing audio:', error);
        updatePlayerStatus('Gagal memutar audio');
      }
    }

    async function playAudioFile(audioPath) {
      if (!player) {
        logAudio('‚ùå Player audio tidak ditemukan');
        return Promise.reject('Player not found');
      }
      
      return new Promise(function(resolve, reject) {
        try {
          logAudio(`üîä Mencoba memutar: ${audioPath}`);
          player.src = audioPath;
          
          // Handle error saat memuat audio
          player.onerror = function() {
            logAudio(`‚ùå Gagal memuat audio: ${audioPath}`);
            reject(new Error(`Gagal memuat audio: ${audioPath}`));
          };
          
          player.play()
            .then(function() {
              logAudio(`‚ñ∂Ô∏è Memutar: ${audioPath}`);
              player.onended = function() {
                logAudio(`‚úÖ Selesai memutar: ${audioPath}`);
                resolve();
              };
            })
            .catch(error => {
              logAudio(`‚ùå Error saat memutar audio: ${error.message}`);
              reject(error);
            });
        } catch (error) {
          logAudio(`‚ùå Error: ${error.message}`);
          reject(error);
        }
      });
    }

    async function playBell() {
      // Menggunakan file bell yang ada
      return playAudioFile('audio/bell.MP3');
    }

    function updatePlayerStatus(message) {
      const statusElement = document.querySelector('.status-text');
      if (statusElement) {
        statusElement.textContent = message;
      }
    }
  </script>
</body>
</html>
