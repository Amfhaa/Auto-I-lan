<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>BAPEN Auto-I'lan</title>
  <link rel="icon" type="image/svg+xml" href="logo_bapen.svg">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ========== Neo-Brutalism Retro + Islami Accent ========== */
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Poppins', sans-serif;
      background: #fffd99;
      color: #111;
    }

    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px 20px;
      background: #111;
      color: #fffd99;
      border: 2px solid #111;
      box-shadow: 4px 4px 0 #111;
      margin-bottom: 20px;
      font-family: 'Poppins', sans-serif;
    }

    h1 {
      margin: 20px 0;
      font-size: 1.8em;
      font-family: 'Poppins', sans-serif;
      font-weight: 600;
    }

    /* Controls styling */
    .controls {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin: 25px 0;
    }

    select, button {
      padding: 10px 15px;
      font-size: 1rem;
      border: 2px solid #111;
      background: #fff;
      font-family: 'Poppins', sans-serif;
      box-shadow: 3px 3px 0 #111;
      transition: all 0.1s ease;
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNyAxMGw1IDUgNS01eiIgZmlsbD0iIzExMSIvPjwvc3ZnPg==');
      background-repeat: no-repeat;
      background-position: right 10px center;
      padding-right: 35px;
    }

    select::-ms-expand {
      display: none;
    }

    button {
      cursor: pointer;
      background: #d0b3ff;
      border: 2px solid #111;
      font-weight: 500;
      padding: 10px 20px;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 3px 3px 0 #111;
      transition: all 0.2s ease;
      background-image: none;
    }

    button:hover {
      transform: translate(-1px, -1px);
      box-shadow: 4px 4px 0 #111;
    }

    button:active {
      transform: translate(2px, 2px);
      box-shadow: 1px 1px 0 #111;
    }

    .btn-clear {
      background: #ff6b6b;
      color: white;
    }

    .btn-clear .icon {
      margin: -2px 4px 0 -4px;
    }

    /* Prayer Table Styling */
    .prayer-table {
      width: 100%;
      margin: 25px 0;
      border-collapse: collapse;
      box-shadow: 5px 5px 0 #111;
      font-family: 'Poppins', sans-serif;
    }
    
    .prayer-table th, .prayer-table td {
      border: 2px solid #111;
      padding: 15px;
      text-align: center;
    }
    
    .prayer-table th {
      background: #d0b3ff;
      font-size: 1.1em;
      text-transform: uppercase;
      font-weight: 600;
    }
    
    .prayer-table td {
      background: #fff;
      font-size: 1.2em;
      font-weight: 500;
    }
    
    .prayer-table .active {
      background: #fffd99;
      position: relative;
    }
    
    .prayer-table .active::after {
      content: '';
      position: absolute;
      right: 15px;
      top: 50%;
      transform: translateY(-50%);
      width: 28px;
      height: 28px;
      background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptLTIgMTVsLTUtNSAxLjQxLTEuNDFMMTAgMTQuMTdsNy41OS03LjU5TDE5IDhsLTkgOXoiIGZpbGw9IiMxMTEiLz48L3N2Zz4=') no-repeat center center;
      background-size: contain;
      filter: drop-shadow(2px 2px 0 rgba(0,0,0,0.2));
    }

    /* Log Container Styling */
    .log-container {
      position: relative;
      margin: 25px 0;
      border: 2px solid #111;
      background: #fff;
      min-height: 120px;
      padding: 15px;
      box-shadow: 5px 5px 0 #111;
    }
    
    #audio-log {
      font-family: 'Poppins', sans-serif;
      font-size: 0.9em;
      min-height: 60px;
      max-height: 250px;
      overflow-y: auto;
      line-height: 1.6;
    }

    #audio-log::-webkit-scrollbar {
      width: 8px;
    }

    #audio-log::-webkit-scrollbar-track {
      background: #fffbe6;
      border-radius: 4px;
    }

    #audio-log::-webkit-scrollbar-thumb {
      background: #7200ca;
      border-radius: 4px;
    }

    /* Audio Player Styling */
    #player {
      width: 100%;
      margin: 20px 0;
      border: 2px solid #111;
      box-shadow: 3px 3px 0 #111;
      background: #fff;
    }

    /* Custom Audio Player Controls */
    audio::-webkit-media-controls-panel {
      background: #fff;
      border-radius: 0;
    }

    audio::-webkit-media-controls-current-time-display,
    audio::-webkit-media-controls-time-remaining-display {
      color: #111;
      font-family: 'Poppins', sans-serif;
    }

    audio::-webkit-media-controls-timeline {
      background: #d0b3ff;
      border-radius: 0;
      margin: 0 15px;
    }

    audio::-webkit-media-controls-timeline-container {
      padding: 0;
    }

    /* Marquee Styling */
    .announcement-bar {
      background: #ff6b6b;
      color: white;
      padding: 10px;
      margin: -20px -20px 20px -20px;
      border-bottom: 2px solid #111;
      font-weight: bold;
      box-shadow: 0 2px 0 #111;
    }

    .announcement-bar marquee {
      font-size: 1.1em;
    }

    .announcement-text {
      display: inline-block;
      padding: 0 20px;
    }

    .announcement-icon {
      font-size: 1.2em;
      margin: 0 10px;
    }

    /* Icon styling */
    .icon {
      width: 20px;
      height: 20px;
      display: inline-block;
      vertical-align: middle;
      margin: -2px 8px 0;
      filter: drop-shadow(1px 1px 0 rgba(0,0,0,0.3));
    }

    .icon-lg {
      width: 24px;
      height: 24px;
    }

    .icon-white {
      filter: brightness(0) invert(1) drop-shadow(1px 1px 0 rgba(0,0,0,0.3));
    }

    .clock-container {
      display: flex;
      align-items: center;
      gap: 12px;
      background: rgba(255,255,255,0.1);
      padding: 8px 15px;
      border-radius: 4px;
      border: 1px solid rgba(255,255,255,0.2);
      font-family: 'Poppins', sans-serif;
      font-weight: 500;
    }

    .clock-icon {
      width: 22px;
      height: 22px;
      filter: brightness(0) invert(1) drop-shadow(1px 1px 0 rgba(0,0,0,0.5));
    }

    /* Footer styling */
    .footer {
      margin-top: 40px;
      padding: 15px 20px;
      background: #111;
      color: #fffd99;
      text-align: center;
      border: 2px solid #111;
      box-shadow: 4px 4px 0 #111;
      font-size: 0.9em;
      letter-spacing: 0.5px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      font-family: 'Poppins', sans-serif;
      font-weight: 400;
    }

    .footer img {
      height: 30px;
      width: auto;
    }

    #ilan-status {
      font-family: 'Poppins', sans-serif;
      font-weight: 400;
    }

    /* Responsive Styling */
    @media screen and (max-width: 768px) {
      body {
        padding: 10px;
      }

      .top-bar {
        flex-direction: column;
        gap: 10px;
        text-align: center;
        padding: 10px;
      }

      .clock-container {
        width: 100%;
        justify-content: center;
      }

      h1 {
        font-size: 1.4em;
        text-align: center;
      }

      #ilan-status {
        text-align: center;
        margin: -10px 0 15px;
      }

      .controls {
        flex-direction: column;
        gap: 10px;
        margin: 15px 0;
      }

      select, button {
        width: 100%;
        text-align: left;
        justify-content: center;
        font-size: 0.95rem;
        padding: 12px 15px;
        border-radius: 0;
        -webkit-border-radius: 0;
      }

      select {
        background-position: right 15px center;
        background-size: 20px;
        padding-right: 40px;
      }

      button {
        text-align: center;
      }

      .prayer-table {
        font-size: 0.9em;
      }

      .prayer-table th {
        font-size: 0.9em;
        padding: 8px 4px;
      }

      .prayer-table td {
        font-size: 1em;
        padding: 8px 4px;
      }

      .prayer-table .active::after {
        width: 20px;
        height: 20px;
        right: 5px;
      }

      .announcement-bar {
        margin: -10px -10px 15px -10px;
      }

      .announcement-bar marquee {
        font-size: 0.9em;
      }

      .footer {
        flex-direction: column;
        gap: 10px;
        text-align: center;
        padding: 10px;
      }

      #audio-log {
        font-size: 0.85em;
      }
    }

    @media screen and (max-width: 480px) {
      .prayer-table th {
        font-size: 0.8em;
        padding: 6px 2px;
      }

      .prayer-table td {
        font-size: 0.9em;
        padding: 6px 2px;
      }

      .prayer-table .active::after {
        width: 16px;
        height: 16px;
        right: 2px;
      }

      h1 {
        font-size: 1.2em;
      }

      #countdown {
        display: block;
        margin-top: 5px;
      }

      .icon-lg {
        width: 20px;
        height: 20px;
      }
    }
  </style>
</head>
<body>

  <div class="announcement-bar">
    <marquee scrollamount="8" behavior="scroll">
      <span class="announcement-text">
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTIgMkM2LjQ4IDIgMiA2LjQ4IDIgMTJzNC40OCAxMCAxMCAxMCAxMC00LjQ4IDEwLTEwUzE3LjUyIDIgMTIgMnptMSAxNWgtMnYtMmgydjJ6bTAtNGgtMlY3aDJ2NnoiIGZpbGw9IiNGRkYiLz48L3N2Zz4=" class="icon icon-white" alt="warning">
        WEBSITE UNDER CONSTRUCTION, MOHON BERSABAR YA GESS. AUDIO I'LAN BELUM DI INPUT SEMUA. BELUM JUGA DI AUTOMATISASI UNTUK OTOMATIS MEMUTAR SUARA I'LAN APABILA JADWAL ADZANNYA
        <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTkuMTQgMTIuOTRjLjA0LS4zLjA2LS42MS4wNi0uOTQgMC0uMzItLjAyLS42NC0uMDctLjk0bDIuMDMtMS41OGMuMTgtLjE0LjIzLS4zNC4xMi0uNTJsLTEuOTItMy4zMmMtLjEyLS4yMi0uMzctLjI5LS41OS0uMjJsLTIuMzkuOTZjLS41LS4zOC0xLjA0LS42OS0xLjYyLS45NEwxNC40IDIuODFjLS4wNC0uMjQtLjI0LS40MS0uNDgtLjQxaC0zLjg0Yy0uMjQgMC0uNDMuMTctLjQ3LjQxbC0uMzYgMi41NGMtLjU5LjI0LTEuMTMuNTctMS42Mi45NGwtMi4zOS0uOTZjLS4yMi0uMDktLjQ3IDAtLjU5LjIyTDIuNzQgOC44N2MtLjEyLjIxLS4wOC40MS4xMi41MmwyLjAzIDEuNThjLS4wNS4zLS4wOS42My0uMDkuOTQgMCAuMzEuMDIuNjQuMDcuOTRsLTIuMDMgMS41OGMtLjE4LjE0LS4yMy4zNC0uMTIuNTJsMS45MiAzLjMyYy4xMi4yMi4zNy4yOS41OS4yMmwyLjM5LS45NmMuNS4zOCAxLjA0LjY5IDEuNjIuOTRsLjM2IDIuNTRjLjA1LjI0LjI0LjQxLjQ4LjQxaDMuODRjLjI0IDAgLjQ0LS4xNy40Ny0uNDFsLjM2LTIuNTRjLjU5LS4yNCAxLjEzLS41NiAxLjYyLS45NGwyLjM5Ljk2Yy4yMi4wOC40Ny0uMDEuNTktLjIybDEuOTItMy4zMmMuMTItLjIyLjA3LS40Mi0uMTItLjUybC0yLjAzLTEuNTh6TTEyIDE1LjZjLTEuOTggMC0zLjYtMS42Mi0zLjYtMy42czEuNjItMy42IDMuNi0zLjYgMy42IDEuNjIgMy42IDMuNi0xLjYyIDMuNi0zLjYgMy42eiIgZmlsbD0iI0ZGRiIvPjwvc3ZnPg==" class="icon icon-white" alt="settings">
      </span>
    </marquee>
  </div>

  <div class="top-bar">
    <div class="clock-container">
      <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTEuOTkgMkM2LjQ3IDIgMiA2LjQ4IDIgMTJzNC40NyAxMCA5Ljk5IDEwQzE3LjUyIDIyIDIyIDE3LjUyIDIyIDEyUzE3LjUyIDIgMTEuOTkgMnpNMTIgMjBjLTQuNDIgMC04LTMuNTgtOC04czMuNTgtOCA4LTggOCAzLjU4IDggOC0zLjU4IDgtOCA4eiIgZmlsbD0iI0ZGRiIvPjxwYXRoIGQ9Ik0xMi41IDdIMTF2NmwzLjI1IDMuMjUuNzUtLjc1TDEyLjUgMTNWN3oiIGZpbGw9IiNGRkYiLz48L3N2Zz4=" class="clock-icon" alt="clock">
    <div id="clock">--:--:--</div>
      <div style="color:#fffd99;font-size:0.9em">Depok, Jawa Barat, Indonesia</div>
    </div>
    <div id="date-hijri">Loading...</div>
  </div>

  <h1>
    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTEuOTkgMkM2LjQ3IDIgMiA2LjQ4IDIgMTJzNC40NyAxMCA5Ljk5IDEwQzE3LjUyIDIyIDIyIDE3LjUyIDIyIDEyUzE3LjUyIDIgMTEuOTkgMnpNMTIgMjBjLTQuNDIgMC04LTMuNTgtOC04czMuNTgtOCA4LTggOCAzLjU4IDggOC0zLjU4IDgtOCA4eiIgZmlsbD0iIzExMSIvPjxwYXRoIGQ9Ik0xMi41IDdIMTF2NmwzLjI1IDMuMjUuNzUtLjc1TDEyLjUgMTNWN3oiIGZpbGw9IiMxMTEiLz48L3N2Zz4=" class="icon icon-lg" alt="timer">
    <span id="countdown">Menghitung...</span>
  </h1>
  <div id="ilan-status" style="margin: -15px 0 20px 44px; font-style: italic;">tidak memutar suara i'lan</div>

  <div class="controls">
    <select id="member">
      <option value="">Pilih Anggota</option>
      <option value="alfatih">Al-Fatih</option>
      <option value="imam">Imam</option>
      <option value="udin">Udin</option>
      <option value="gusti">Gusti</option>
      <option value="danish">Danish</option>
      <option value="feyrzan">Feyrzan</option>
    </select>
    <select id="prayer">
      <option value="">Pilih Waktu Sholat</option>
      <option value="fajr">Subuh</option>
      <option value="dhuhr">Dzuhur</option>
      <option value="asr">Ashar</option>
      <option value="maghrib">Maghrib</option>
      <option value="isha">Isya</option>
    </select>
    <select id="type">
      <option value="">Pilih Jenis I'lan</option>
      <option value="awal">Awal</option>
      <option value="tsani">Tsani</option>
      <option value="akhir">Akhir</option>
    </select>
    <button id="btnPlay">
      <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNOCA2djEybDEwLTZ6IiBmaWxsPSIjMTExIi8+PC9zdmc+" class="icon" alt="play"> Play
    </button>
    <button id="btnPause">
      <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNOCA1djE0aDN2LTE0ek0xMyA1djE0aDN2LTE0eiIgZmlsbD0iIzExMSIvPjwvc3ZnPg==" class="icon" alt="pause"> Pause
    </button>
    <button onclick="clearLog()" class="btn-clear">
      <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNNiAxOWMwIDEuMSAwLjkgMiAyIDJoOGMxLjEgMCAyLTAuOSAyLTJWN0g2djEyek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDV2MmgxNFY0eiIgZmlsbD0iI0ZGRiIvPjwvc3ZnPg==" class="icon icon-white" alt="clear"> Clear Log
    </button>
  </div>

  <div class="log-container">
    <div id="audio-log"></div>
  </div>
  <audio id="player" controls></audio>

  <table class="prayer-table">
    <tr>
      <th>Subuh</th>
      <th>Dzuhur</th>
      <th>Ashar</th>
      <th>Maghrib</th>
      <th>Isya</th>
    </tr>
    <tr>
      <td id="time-fajr">--:--</td>
      <td id="time-dhuhr">--:--</td>
      <td id="time-asr">--:--</td>
      <td id="time-maghrib">--:--</td>
      <td id="time-isha">--:--</td>
    </tr>
  </table>

<script>
  // ===== JADWAL SHOLAT & SCHEDULER =====
  let timings = null;
  const player = document.getElementById('player');
  const audioLog = document.getElementById('audio-log');
  const ilanStatus = document.getElementById('ilan-status');

  async function fetchPrayerTimes() {
    try {
      // Koordinat Depok
      const latitude = -6.4;
      const longitude = 106.8186;
      
      // Get current date
      const now = new Date();
      const timestamp = Math.floor(now.getTime() / 1000);
      
      // Fetch dari API Aladhan
      const response = await fetch(`https://api.aladhan.com/v1/timings/${timestamp}?latitude=${latitude}&longitude=${longitude}&method=11`);
      const data = await response.json();
      
      if (data && data.data && data.data.timings) {
        logAudio('‚úÖ Berhasil mengambil jadwal dari API Aladhan');
        return {
          Imsak: data.data.timings.Imsak,
          Fajr: data.data.timings.Fajr,
          Sunrise: data.data.timings.Sunrise,
          Dhuhr: data.data.timings.Dhuhr,
          Asr: data.data.timings.Asr,
          Maghrib: data.data.timings.Maghrib,
          Isha: data.data.timings.Isha,
          Midnight: data.data.timings.Midnight
        };
      } else {
        throw new Error('Format data tidak sesuai');
      }
    } catch (err) {
      logAudio(`‚ùå Error mengambil jadwal: ${err.message}`);
      // Fallback ke jadwal statis jika API gagal
      return {
        Imsak: '04:31',
        Fajr: '04:41',
        Sunrise: '05:57',
        Dhuhr: '12:01',
        Asr: '15:20',
        Maghrib: '18:00',
        Isha: '19:10',
        Midnight: '00:00'
      };
    }
  }

  async function initializeScheduler() {
    try {
      logAudio('‚è≥ Menginisialisasi jadwal dari API Aladhan untuk Depok');
      timings = await fetchPrayerTimes();
      scheduleAll();
      updateCountdown();
      updatePrayerTable();
      logAudio('‚úÖ Jadwal sholat berhasil dimuat');
    } catch (err) {
      logAudio(`‚ùå Error: ${err.message}`);
    }
  }

  // Jalankan scheduler saat halaman dimuat
  window.addEventListener('load', () => {
    initializeScheduler();
    // Update setiap jam untuk antisipasi pergantian hari
    setInterval(initializeScheduler, 1000*60*60);
  });

  // Update jam setiap detik dengan format yang akurat
  function updateClock() {
    const now = new Date();
    const timeStr = now.toLocaleTimeString('id-ID', { 
      hour12: false,
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit'
    }).replace(/\./g, ':');
    
    const dateStr = now.toLocaleDateString('id-ID', {
      weekday: 'long',
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    document.getElementById('clock').textContent = timeStr;
    document.getElementById('date-hijri').textContent = dateStr;
  }
  setInterval(updateClock, 1000);
  updateClock();

  // ===== CALC NEXT PRAYER & COUNTDOWN =====
  function getNextEvent() {
    if(!timings) return null;
    const now = new Date();
    const events = [];
    
    // Konversi waktu sholat ke timestamp hari ini
    const prayerTimes = {
      fajr: convertToDate(timings.Fajr),
      dhuhr: convertToDate(timings.Dhuhr),
      asr: convertToDate(timings.Asr),
      maghrib: convertToDate(timings.Maghrib),
      isha: convertToDate(timings.Isha)
    };

    // Tambahkan semua waktu sholat yang belum lewat ke events
    for (let [prayer, time] of Object.entries(prayerTimes)) {
      if (time > now) {
        events.push({
          prayer,
          when: time,
          type: 'adzan'
        });
      }
    }

    // Urutkan berdasarkan waktu terdekat
    events.sort((a,b) => a.when - b.when);
    return events[0] || null;
  }

  function convertToDate(timeStr) {
    const [hours, minutes] = timeStr.split(':').map(Number);
    const date = new Date();
    date.setHours(hours, minutes, 0, 0);
    return date;
  }

  function updateCountdown() {
    const next = getNextEvent();
    if (!next) {
      document.getElementById('countdown').textContent = 'Memuat jadwal...';
      return;
    }
    
    const diff = next.when - new Date();
    let s = Math.floor((diff%60000)/1000);
    let m = Math.floor(diff/60000);
    let h = Math.floor(m/60);
    m = m % 60;
    
    let countdownStr = '';
    if (h > 0) {
      countdownStr = `${h} jam ${m} menit ${s} detik`;
    } else {
      countdownStr = `${m} menit ${s} detik`;
    }

    const prayerNames = {
      fajr: 'Subuh',
      dhuhr: 'Dzuhur',
      asr: 'Ashar',
      maghrib: 'Maghrib',
      isha: 'Isya'
    };

    document.getElementById('countdown').textContent =
      `${countdownStr} menuju adzan ${prayerNames[next.prayer]}`;
  }
  
  // Update countdown setiap 500ms
  setInterval(updateCountdown, 500);

  // ===== AUTO-PLAY SCHEDULER =====
  function scheduleAll(){
    const next = getNextEvent();
    if (!next) return;
    // clear existing timers
    if (window.nextTimer) clearTimeout(window.nextTimer);
    const delay = next.when - new Date();
    window.nextTimer = setTimeout(()=>{
      playAudio(next.member, next.prayer, next.type);
      scheduleAll(); // schedule berikutnya
    }, delay);
  }

  // ===== AUDIO & VISUALIZER =====
  function logAudio(msg) {
    const audioLog = document.getElementById('audio-log');
    const logLine = document.createElement('div');
    logLine.className = 'log-message';
    
    // Menentukan tipe pesan
    if (msg.includes('‚úÖ')) {
      logLine.className += ' success';
    } else if (msg.includes('‚ùå')) {
      logLine.className += ' error';
    } else if (msg.includes('‚ö†Ô∏è')) {
      logLine.className += ' warning';
    }
    
    logLine.innerHTML = msg;
    audioLog.appendChild(logLine);
    audioLog.scrollTop = audioLog.scrollHeight;
  }

  function updateIlanStatus(member = '', prayer = '', type = '') {
    if (!player.src || player.paused) {
      ilanStatus.textContent = 'tidak memutar suara i\'lan';
    } else {
      const prayerNames = {
        fajr: 'Subuh',
        dhuhr: 'Dzuhur',
        asr: 'Ashar',
        maghrib: 'Maghrib',
        isha: 'Isya'
      };
      
      const memberNames = {
        alfatih: 'Al-Fatih',
        imam: 'Imam',
        udin: 'Udin',
        gusti: 'Gusti',
        danish: 'Danish',
        feyrzan: 'Feyrzan'
      };

      const displayMember = memberNames[member] || member;
      const displayPrayer = prayerNames[prayer] || prayer;
      const displayType = type.charAt(0).toUpperCase() + type.slice(1);
      
      ilanStatus.textContent = `i'lan ${displayMember} - ${displayPrayer} - ${displayType} sedang diputar`;
    }
  }

  async function playAudio(member='alfatih', prayer='maghrib', type='tsani') {
    try {
      logAudio(`Attempting to play: member=${member}, prayer=${prayer}, type=${type}`);
      
      // Reset audio state
      player.pause();
      player.currentTime = 0;
      
      // Show controls & set volume
      player.controls = true;
      player.volume = 1;
      player.muted = false;
      
      // Set source
      let fileName;
      if (member === 'alfatih' && prayer === 'maghrib' && type === 'tsani') {
        fileName = 'alfatih_magrib_tsani.mp3';
      } else {
        fileName = `${member}_${prayer}_${type}.mp3`;
      }
      
      player.src = `audio/${fileName}`;
      
      logAudio(`üéµ Audio settings:
- Source: ${player.src}
- Volume: ${player.volume}
- Muted: ${player.muted}
- File: ${fileName}`);
      
      // Play
      const playPromise = player.play();
      if (playPromise !== undefined) {
        await playPromise;
        updateIlanStatus(member, prayer, type);
        logAudio("<span style='color:green'>‚úÖ Playback started</span>");
      }
      
    } catch (err) {
      logAudio(`<span style='color:red'>‚ùå Error in playAudio: ${err.message}</span>`);
      updateIlanStatus();
      
      // Tambahan informasi error
      if (err.name === 'NotAllowedError') {
        logAudio("<span style='color:orange'>‚ö†Ô∏è Browser memblokir autoplay. Coba klik player control secara manual.</span>");
      } else if (err.name === 'NotFoundError') {
        logAudio("<span style='color:orange'>‚ö†Ô∏è File audio tidak ditemukan. Pastikan file ada di folder yang benar.</span>");
      }
    }
  }

  // Event listeners untuk audio
  player.addEventListener('loadstart', () => logAudio('üéµ Audio mulai loading...'));
  player.addEventListener('canplay', () => logAudio('‚úÖ Audio siap diputar'));
  player.addEventListener('playing', () => logAudio('‚ñ∂Ô∏è Audio mulai bermain'));
  player.addEventListener('pause', () => {
    logAudio('‚è∏Ô∏è Audio dipause');
    updateIlanStatus();
  });
  player.addEventListener('ended', () => {
    logAudio('‚èπÔ∏è Audio selesai');
    updateIlanStatus();
  });

  // Manual controls
  document.getElementById('btnPlay').onclick = () => {
    const m = document.getElementById('member').value;
    const p = document.getElementById('prayer').value;
    const t = document.getElementById('type').value;
    if(!m||!p||!t) return alert("Pilih anggota, waktu, & jenis i'lan dulu!");
    playAudio(m,p,t);
  };
  
  document.getElementById('btnPause').onclick = () => player.pause();

  // Fungsi untuk update tabel jadwal
  function getCurrentPrayer() {
    if (!timings) return null;
    const now = new Date();
    
    // Konversi waktu sholat ke timestamp hari ini
    const prayerTimes = {
      fajr: convertToDate(timings.Fajr),
      dhuhr: convertToDate(timings.Dhuhr),
      asr: convertToDate(timings.Asr),
      maghrib: convertToDate(timings.Maghrib),
      isha: convertToDate(timings.Isha)
    };

    // Urutkan waktu sholat
    const orderedPrayers = Object.entries(prayerTimes).sort((a, b) => a[1] - b[1]);
    
    // Cari waktu sholat yang sedang berlangsung
    for (let i = orderedPrayers.length - 1; i >= 0; i--) {
      if (now >= orderedPrayers[i][1]) {
        return orderedPrayers[i][0];
      }
    }
    
    // Jika sekarang sebelum subuh, return isya (waktu sholat terakhir dari hari sebelumnya)
    return 'isha';
  }

  function updatePrayerTable() {
    if (!timings) return;
    
    document.getElementById('time-fajr').textContent = timings.Fajr;
    document.getElementById('time-dhuhr').textContent = timings.Dhuhr;
    document.getElementById('time-asr').textContent = timings.Asr;
    document.getElementById('time-maghrib').textContent = timings.Maghrib;
    document.getElementById('time-isha').textContent = timings.Isha;

    // Reset semua highlight
    Object.keys(timings).forEach(prayer => {
      const elementId = `time-${prayer.toLowerCase()}`;
      if (document.getElementById(elementId)) {
        document.getElementById(elementId).classList.remove('active');
      }
    });

    // Tandai waktu sholat yang sedang berlangsung
    const currentPrayer = getCurrentPrayer();
    if (currentPrayer) {
      const elementId = `time-${currentPrayer}`;
      document.getElementById(elementId).classList.add('active');
    }
  }

  // Update tabel setiap menit
  setInterval(updatePrayerTable, 60000);

  // Fungsi untuk membersihkan log
  function clearLog() {
    const audioLog = document.getElementById('audio-log');
    const clearMessage = document.createElement('div');
    clearMessage.className = 'log-message success';
    clearMessage.innerHTML = '<span>‚ú® Log dibersihkan</span>';
    audioLog.innerHTML = '';
    audioLog.appendChild(clearMessage);
    setTimeout(() => {
      audioLog.innerHTML = '';
    }, 1000);
  }
</script>

  <div class="footer">
    <img src="logo_bapen.svg" alt="Logo BAPEN">
    &copy; Language of Education ISPAH 2025
  </div>

</body>
</html>
